<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindForge Knowledge Base</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <link rel="stylesheet" href="css/global.css">
    
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { 'bg-dark': '#000000', 'bg-light': '#f8fafc' } } } }
    </script>

    <style>
        /* 1. åˆ†ç±»èƒ¶å›Šå¯¼èˆª */
        .category-pill {
            padding: 6px 20px; border-radius: 99px; font-size: 11px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s;
            cursor: pointer; border: 1px solid transparent;
        }
        .dark .category-pill.inactive { color: #666; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); }
        .dark .category-pill.inactive:hover { color: #fff; border-color: rgba(255,255,255,0.2); }
        .dark .category-pill.active { color: #000; background: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); font-weight: 900; }
        
        html:not(.dark) .category-pill.inactive { color: #888; background: #f1f1f1; }
        html:not(.dark) .category-pill.active { color: #fff; background: #000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* 2. Quill.js æ²‰æµ¸å¼æ ·å¼é‡å†™ */
        .ql-container {
            font-family: 'Microsoft YaHei', sans-serif !important;
            font-size: 16px !important;
            border: none !important; 
        }
        .ql-toolbar {
            border: none !important;
            border-bottom: 1px solid rgba(255,255,255,0.05) !important;
            padding: 12px 24px !important;
        }
        .dark .ql-toolbar { background: #0a0a0a !important; }
        html:not(.dark) .ql-toolbar { border-bottom: 1px solid rgba(0,0,0,0.05) !important; background: #fff !important; }
        
        .ql-editor {
            padding: 40px 60px !important; 
            line-height: 1.8 !important; 
            color: #e5e7eb;
            min-height: 80vh; 
            background-color: transparent !important; 
            text-align: left !important;
        }
        .dark .ql-editor { color: #e5e7eb; }
        html:not(.dark) .ql-editor { color: #1f2937; }

        /* æ ‡é¢˜å’Œä»£ç å—ç¾åŒ– (å¢å¼ºå—çº§æ„Ÿ) */
        .ql-editor h1 { font-size: 2em; font-weight: 800; margin-top: 2em; margin-bottom: 0.5em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .ql-editor h2 { font-size: 1.5em; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; color: #3b82f6; }
        .ql-syntax {
            background: #1e1e1e !important; color: #d4d4d4 !important;
            border-radius: 8px; padding: 15px !important;
            font-family: 'JetBrains Mono', monospace !important;
            font-size: 13px;
            margin-top: 1em; margin-bottom: 1em;
        }

        /* æŸ¥çœ‹æ¨¡å¼çš„æ’ç‰ˆå®¹å™¨ */
        .read-mode-content {
            padding: 40px 60px;
            line-height: 1.8;
            color: #e5e7eb;
            text-align: left; /* å¼ºåˆ¶å·¦å¯¹é½ */
        }
        .dark .read-mode-content { color: #e5e7eb; }
        html:not(.dark) .read-mode-content { color: #1f2937; }
        .read-mode-content img { max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0; }

        /* ğŸŸ¢ ä¿®å¤ 1: Private Toggle å±…ä¸­ */
        .toggle-label {
            top: 1px !important; /* å¼ºåˆ¶ä¸‹ç§»ï¼Œè§£å†³è¢«é®æŒ¡çš„é—®é¢˜ */
        }
        
        /* 3. å…¨å±æŠ½å±‰ (ä¿æŒ V6.x æ¶æ„) */
        .editor-drawer {
            position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 1000px;
            z-index: 100; transform: translateX(100%); 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
            box-shadow: -20px 0 50px rgba(0,0,0,0.5);
        }
        .dark .editor-drawer { background: #0a0a0a; border-left: 1px solid rgba(255,255,255,0.1); }
        .editor-drawer.open { transform: translateX(0); }

        /* 4. æ ‡é¢˜è¾“å…¥ */
        .doc-title-input {
            font-size: 36px; font-weight: 900; background: transparent; border: none; outline: none;
            width: 100%; margin-bottom: 30px; line-height: 1.2; letter-spacing: -1px;
        }
        .dark .doc-title-input { color: white; } .dark .doc-title-input::placeholder { color: #333; }
        
        /* åˆ—è¡¨å¡ç‰‡ (æ¢å¤ Hover å…‰æ•ˆ) */
        .wiki-card {
            border-radius: 16px; position: relative; overflow: hidden; cursor: pointer; transition: all 0.3s;
            border: 1px solid transparent;
        }
        .dark .wiki-card { background: rgba(20,20,20,0.6); border-color: rgba(255,255,255,0.05); }
        .dark .wiki-card:hover { transform: translateY(-4px); border-color: rgba(59, 130, 246, 0.5); box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2); }
        html:not(.dark) .wiki-card { background: #fff; border-color: rgba(0,0,0,0.05); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        html:not(.dark) .wiki-card:hover { transform: translateY(-4px); border-color: rgba(0,0,0,0.1); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
    
        /* ä¿®å¤ 4: è¿”å›/ç¼–è¾‘æŒ‰é’® (ä¸»é¢˜è“åº•è‰²) */
        .btn-nav-action {
            display: flex; align-items: center; justify-content: center;
            padding: 8px 16px; border-radius: 99px; font-size: 11px; font-weight: 700;
            text-transform: uppercase; transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff; background: transparent;
        }
        .btn-nav-action:hover {
            color: #000; background: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transform: scale(1.05);
        }
        .btn-nav-action.edit-mode {
            background: #3b82f6; border-color: #3b82f6; color: white;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        html:not(.dark) .btn-nav-action.edit-mode {
            background: #3b82f6; color: white;
        }
    </style>
</head>
<body class="bg-bg-light dark:bg-bg-dark h-screen flex overflow-hidden transition-colors duration-500 text-gray-900 dark:text-gray-200">

<script src="js/config.js"></script>

<div id="app" v-cloak class="h-full w-full flex relative z-10">

    <aside :class="['floating-sidebar w-64 flex flex-col justify-between transition-transform duration-300 fixed md:relative z-40', mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0']">
        <div>
            <div class="h-20 flex items-center px-8 border-b border-gray-200 dark:border-white/5">
                <span class="text-xl font-black tracking-tighter text-black dark:text-white cyber-logo">MindForge <span class="text-[10px] opacity-60 ml-1 font-normal">WIKI</span></span>
            </div>
            <nav class="p-4 space-y-6">
                <div>
                    <div class="text-[10px] font-bold text-gray-400 dark:text-gray-600 uppercase tracking-widest mb-3 pl-4">System Core</div>
                    <a href="index.html" class="nav-item w-full text-left block p-3 mb-1 text-xs">System Home ä¸»é¡µ</a>
                    <a href="finance.html" class="nav-item w-full text-left block p-3 mb-1 text-xs">Finance é‡‘è</a>
                    <button class="nav-item w-full text-left block p-3 text-xs active">Knowledge Base çŸ¥è¯†åº“</button>
                </div>
                <div>
                    <div class="text-[10px] font-bold text-gray-400 dark:text-gray-600 uppercase tracking-widest mb-3 pl-4">Tags / æ ‡ç­¾</div>
                    <div class="space-y-1 pl-2">
                        <template v-for="tag in currentSubCategories" :key="tag">
                            <div :class="['flex items-center justify-between p-2 rounded-md transition cursor-pointer text-xs group', currentSub === tag ? 'bg-gray-200 dark:bg-white/20 text-black dark:text-white' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10']">
                                <span @click="currentSub = tag">
                                    {{ tag === 'é»˜è®¤' ? 'ä¸»æ–‡æ¡£' : tag }}
                                </span>
                                <button v-if="tag !== 'å…¨éƒ¨' && tag !== 'é»˜è®¤'" @click.stop="deleteCategory(tag)" class="text-red-500 opacity-70 group-hover:opacity-100 text-[10px] ml-2">Delete</button>
                            </div>
                        </template>
                        <button @click="addCategory" class="w-full text-left text-[10px] text-gray-500 hover:text-black dark:hover:text-white py-2 px-2 border-dashed border-gray-400 dark:border-gray-600 rounded-md transition">+ Add New Tag æ–°å»ºæ ‡ç­¾</button>
                    </div>
                </div>
            </nav>
        </div>
        <div class="p-6 border-t border-gray-200 dark:border-white/5">
            <div class="text-[10px] text-gray-500 font-mono">ENCRYPTED STORAGE</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-transparent relative overflow-hidden w-full pl-4 pt-4 no-scroll-x">
        
        <header class="h-16 flex items-center justify-between px-8 shrink-0 mb-4 mr-4 cyber-card z-50 sticky top-0 bg-white/80 dark:bg-[#0a0a0a]/80 backdrop-blur-xl border border-gray-200 dark:border-white/10 shadow-lg !overflow-visible">
            <div class="flex items-center gap-6 overflow-hidden">
                <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden text-2xl">â˜°</button>
                <span class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] whitespace-nowrap">Knowledge Center çŸ¥è¯†ä¸­å¿ƒ</span>
            </div>

            <div class="flex items-center gap-4 shrink-0">
                <button @click="toggleTheme" class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 dark:border-white/20 text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 transition">
                    <span v-if="isDark">â˜€</span><span v-else>â˜¾</span>
                </button>
                <button @click="createNote" class="btn-cyber text-black dark:text-white border-gray-300 dark:border-white/20 rounded-lg hover:bg-black hover:text-white dark:hover:bg-white dark:hover:text-black">
                    + New Doc æ–°å»º
                </button>
            </div>
        </header>

        <div class="flex justify-center gap-3 mb-6 shrink-0 animate-fade-in">
            <button @click="switchCategory('wiki')" :class="['category-pill', currentCategory === 'wiki' ? 'active' : 'inactive']">Wiki çŸ¥è¯†åº“</button>
            <button @click="switchCategory('idea')" :class="['category-pill', currentCategory === 'idea' ? 'active' : 'inactive']">Idea çµæ„Ÿ</button>
            <button @click="switchCategory('blog')" :class="['category-pill', currentCategory === 'blog' ? 'active' : 'inactive']">Blog åšå®¢</button>
            <button @click="switchCategory('file')" :class="['category-pill', currentCategory === 'file' ? 'active' : 'inactive']">File æ–‡ä»¶</button>
        </div>

        <div class="flex-1 overflow-y-auto pr-4 pb-4 relative z-10 custom-scroll">
            <div v-if="filteredNotes.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pt-2">
                <div v-for="note in filteredNotes" :key="note.id" @click="viewNote(note)" class="wiki-card p-6 flex flex-col h-64 group">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-[10px] font-mono text-gray-400 uppercase tracking-widest bg-gray-100 dark:bg-white/5 px-2 py-1 rounded">{{ note.sub_category === 'é»˜è®¤' ? 'ä¸»æ–‡æ¡£' : note.sub_category }}</span>
                        <span v-if="!note.is_public" class="w-2 h-2 rounded-full bg-red-500"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white line-clamp-2 mb-3 leading-tight group-hover:text-blue-500 transition">{{ note.title }}</h3>
                    <div class="flex-1 overflow-hidden relative">
                        <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed line-clamp-4 opacity-80">{{ getSummary(note.content) }}</p>
                        <div class="absolute bottom-0 left-0 w-full h-8 bg-gradient-to-t from-white dark:from-[#141414] to-transparent"></div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-200 dark:border-white/5 flex justify-between items-center text-[10px] text-gray-400">
                        <span>{{ formatTime(note.updated_at || note.created_at) }}</span>
                        <span class="group-hover:translate-x-1 transition">OPEN â†’</span>
                    </div>
                </div>
            </div>
            <div v-else class="flex flex-col items-center justify-center h-64 text-gray-400 dark:text-gray-700 opacity-50">
                <p class="text-xs font-bold tracking-[0.2em] uppercase">No Documents Found</p>
            </div>
        </div>
    </main>

    <div :class="['editor-drawer', isEditing ? 'open' : '']">
        <div class="h-16 flex justify-between items-center px-8 border-b border-gray-200 dark:border-white/10 shrink-0 bg-white/95 dark:bg-[#0a0a0a]/95 backdrop-blur">
            <button @click="closeEditor" class="btn-nav-action flex items-center gap-2 group">
                <span class="text-lg group-hover:-translate-x-1 transition">â†</span> <span class="uppercase">Back è¿”å›</span>
            </button>
            
            <div class="flex items-center gap-6">
                <span v-if="saveStatus" class="text-[10px] text-green-500 font-mono animate-pulse">{{ saveStatus }}</span>
                
                <div class="flex items-center gap-3 border-r border-gray-200 dark:border-white/10 pr-6">
                    <span :class="['text-[10px] font-bold uppercase tracking-wider', form.is_public ? 'text-green-500' : 'text-red-500']">{{ form.is_public ? 'Public å…¬å¼€' : 'Private ç§å¯†' }}</span>
                    <div class="relative inline-block w-8 h-4 align-middle select-none">
                        <input type="checkbox" v-model="form.is_public" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label @click="form.is_public = !form.is_public" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-700 cursor-pointer w-8"></label>
                    </div>
                </div>

                <button v-if="editorMode === 'view'" @click="startEdit" :class="['btn-nav-action', 'edit-mode']">
                    Edit Doc ç¼–è¾‘
                </button>
                <button v-if="editorMode === 'edit' || editorMode === 'new'" @click="saveNote" class="btn-cyber bg-black text-white dark:bg-white dark:text-black shadow-lg">
                    Save ä¿å­˜
                </button>
                <button v-if="editorMode === 'edit'" @click="cancelEdit" class="text-gray-500 hover:text-black dark:hover:text-white text-xs font-bold uppercase">
                    Cancel å–æ¶ˆ
                </button>

                <button v-if="form.id && editorMode === 'view'" @click="deleteNote(form.id)" class="text-red-500 hover:text-red-400 text-xs font-bold uppercase">Delete åˆ é™¤</button>

            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scroll bg-gray-50 dark:bg-[#0a0a0a]">
            <div class="max-w-4xl mx-auto py-20 px-8 md:px-12">
                <input v-model="form.title" class="doc-title-input" placeholder="Untitled Document..." :disabled="editorMode === 'view'">
                
                <div class="mb-8 p-4 rounded-lg bg-gray-100 dark:bg-white/5 border border-gray-200 dark:border-white/10">
                    <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Document Tag / æ–‡æ¡£æ ‡ç­¾</div>
                    <div class="flex flex-wrap gap-2">
                        <span :class="['px-3 py-1 rounded-full text-xs font-bold transition', currentSub === 'å…¨éƒ¨' || currentSub === 'ä¸»æ–‡æ¡£' ? 'bg-blue-500 text-white' : 'bg-gray-300 dark:bg-gray-700 text-black dark:text-white']">
                            {{ currentCategory }} / {{ form.sub_category === 'é»˜è®¤' ? 'ä¸»æ–‡æ¡£' : form.sub_category }}
                        </span>
                        <select v-if="editorMode !== 'view'" v-model="form.sub_category" class="text-xs py-1 px-2 rounded-lg bg-white dark:bg-gray-800 border dark:border-gray-700 outline-none cursor-pointer">
                            <option v-for="tag in currentSubCategories" :value="tag === 'ä¸»æ–‡æ¡£' ? 'é»˜è®¤' : tag">
                                {{ tag === 'é»˜è®¤' ? 'ä¸»æ–‡æ¡£' : tag }}
                            </option>
                        </select>
                        <span v-else class="text-xs text-gray-400 mt-1"> (åˆ‡æ¢æ¨¡å¼ä»¥ä¿®æ”¹)</span>
                    </div>
                </div>

                <div v-if="editorMode === 'view'" class="read-mode-content" v-html="initialContentToLoad"></div>
                
                <div v-if="editorMode === 'edit' || editorMode === 'new'" id="editorjs"></div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, reactive, nextTick, watch } = Vue

    createApp({
        setup() {
            if (!window._supabase) { console.error("Config Error"); return {}; }
            const _supabase = window._supabase; 
            
            const isDark = ref(true)
            if (localStorage.getItem('theme') === 'light') { isDark.value = false; document.documentElement.classList.remove('dark'); }
            const toggleTheme = () => { isDark.value = !isDark.value; if(isDark.value){document.documentElement.classList.add('dark');localStorage.setItem('theme','dark')}else{document.documentElement.classList.remove('dark');localStorage.setItem('theme','light')} }

            const mobileMenuOpen = ref(false)
            const user = ref(null)
            const notes = ref([])
            const currentCategory = ref('wiki')
            const currentSub = ref('å…¨éƒ¨')
            // ğŸŸ¢ ä¿®å¤ 6: æ ‡ç­¾ç®¡ç† (å°† 'é»˜è®¤' æ ‡ç­¾æ”¾å…¥æ•°ç»„ä¸­ï¼Œæ–¹ä¾¿æ˜¾ç¤º 'ä¸»æ–‡æ¡£')
            const categories = reactive({ 'wiki': ['å…¨éƒ¨', 'ä¸»æ–‡æ¡£'], 'idea': ['å…¨éƒ¨', 'ä¸»æ–‡æ¡£'], 'blog': ['å…¨éƒ¨', 'ä¸»æ–‡æ¡£'], 'file': ['å…¨éƒ¨', 'ä¸»æ–‡æ¡£'] })
            
            const isEditing = ref(false) 
            const editorMode = ref('view'); 
            const form = reactive({ id: null, title: '', is_public: false, sub_category: 'é»˜è®¤' }); // ç¡®ä¿ form æœ‰ sub_category
            const saveStatus = ref('');
            
            let quill = null; 
            const initialContentToLoad = ref(''); 

            // ğŸŸ¢ Quill åˆå§‹åŒ–é€»è¾‘
            const initQuill = (content = '') => {
                if (quill) {
                    quill = null;
                    document.getElementById('editorjs').innerHTML = '';
                }

                nextTick(() => {
                    const container = document.getElementById('editorjs');
                    if (container) {
                        const editorDiv = document.createElement('div');
                        container.appendChild(editorDiv);
                        
                        quill = new Quill(editorDiv, {
                            theme: 'snow',
                            placeholder: 'Start writing...',
                            modules: {
                                toolbar: [
                                    [{ 'header': [1, 2, 3, false] }],
                                    ['bold', 'italic', 'underline', 'strike', 'blockquote', 'code-block'],
                                    [{ 'list': 'ordered'}, { 'list': 'bullet' }, { 'list': 'check' }], 
                                    [{ 'color': [] }, { 'background': [] }],
                                    ['link', 'image', 'video', 'clean']
                                ]
                            }
                        });

                        // åŠ è½½å†…å®¹
                        try {
                            const delta = JSON.parse(content);
                            if (delta.ops) { 
                                quill.setContents(delta);
                            } else {
                                quill.root.innerHTML = content; 
                            }
                        } catch (e) {
                            quill.root.innerHTML = content; 
                        }
                    }
                });
            }

            // ğŸŸ¢ Watcher é©±åŠ¨ Quill åˆå§‹åŒ–
            watch(editorMode, (newMode) => {
                if (newMode === 'edit' || newMode === 'new') {
                    isEditing.value = true;
                    initQuill(initialContentToLoad.value);
                } else {
                    if (quill) {
                        document.getElementById('editorjs').innerHTML = '';
                        quill = null;
                    }
                }
            });


            const fetchNotes = async () => {
                const { data } = await _supabase.from('notes').select('*').neq('category', 'profile').neq('category', 'changelog').order('created_at', { ascending: false });
                if (data) {
                    notes.value = data;
                    // ğŸŸ¢ ä¿®å¤ 6: åŠ¨æ€å¡«å……æ ‡ç­¾åˆ—è¡¨
                    const subs = {};
                    data.forEach(n => {
                        if (n.sub_category && n.sub_category !== 'é»˜è®¤' && !subs[n.category]) {
                            subs[n.category] = new Set();
                        }
                        if (n.sub_category && n.sub_category !== 'é»˜è®¤') {
                            subs[n.category].add(n.sub_category);
                        }
                    });

                    Object.keys(categories).forEach(cat => {
                        categories[cat] = ['å…¨éƒ¨', 'ä¸»æ–‡æ¡£'];
                        if (subs[cat]) {
                            subs[cat].forEach(tag => categories[cat].push(tag));
                        }
                    });
                }
            }

            onMounted(async () => {
                const { data: { session } } = await _supabase.auth.getSession();
                if(session) { user.value = session.user; fetchNotes(); }
                else { window.location.href = 'login.html'; }
            })

            const switchCategory = (cat) => { currentCategory.value = cat; currentSub.value = 'å…¨éƒ¨'; mobileMenuOpen.value = false; }
            // ğŸŸ¢ ä¿®å¤ 6: åˆ—è¡¨åªæ˜¾ç¤ºé 'å…¨éƒ¨' å’Œ 'ä¸»æ–‡æ¡£' çš„æ ‡ç­¾
            const currentSubCategories = computed(() => categories[currentCategory.value].filter(tag => tag !== 'å…¨éƒ¨'))
            
            const filteredNotes = computed(() => notes.value.filter(n => {
                const matchesCategory = n.category === currentCategory.value;
                if (!matchesCategory) return false;
                
                if (currentSub.value === 'å…¨éƒ¨') return true;
                
                // è¿‡æ»¤ä¸»æ–‡æ¡£
                if (currentSub.value === 'ä¸»æ–‡æ¡£') return n.sub_category === 'é»˜è®¤';
                
                return n.sub_category === currentSub.value;
            }))

            // ğŸŸ¢ æµç¨‹ï¼šæ–°å»º -> å¼€å¯ç¼–è¾‘æ¨¡å¼
            const createNote = () => { 
                Object.assign(form, { id: null, title: '', is_public: false, sub_category: 'é»˜è®¤' }); // æ–°å»ºé»˜è®¤ä¸»æ–‡æ¡£
                initialContentToLoad.value = ''; 
                editorMode.value = 'new';
            }

            // ğŸŸ¢ æµç¨‹ï¼šåˆ—è¡¨ç‚¹å‡» -> å¼€å¯æŸ¥çœ‹æ¨¡å¼
            const viewNote = (note) => { 
                Object.assign(form, { id: note.id, title: note.title, is_public: note.is_public, sub_category: note.sub_category || 'é»˜è®¤' });
                initialContentToLoad.value = note.content; 
                editorMode.value = 'view';
                isEditing.value = true;
            }
            
            // ğŸŸ¢ æµç¨‹ï¼šæŸ¥çœ‹é¡µé¢ç‚¹å‡» Edit -> å¼€å¯ç¼–è¾‘æ¨¡å¼
            const startEdit = () => {
                editorMode.value = 'edit';
            }
            
            // ğŸŸ¢ æµç¨‹ï¼šå–æ¶ˆç¼–è¾‘ -> å›åˆ°æŸ¥çœ‹æ¨¡å¼ (å¦‚æœ ID å­˜åœ¨)
            const cancelEdit = () => {
                if (form.id) {
                    editorMode.value = 'view';
                    // é‡æ–°åŠ è½½åŸå§‹å†…å®¹ä»¥è¦†ç›–æœªä¿å­˜çš„ç¼–è¾‘
                    const note = notes.value.find(n => n.id === form.id);
                    if (note) initialContentToLoad.value = note.content;
                } else {
                    closeEditor(); // æ–°å»ºæ–‡æ¡£å–æ¶ˆï¼Œç›´æ¥å…³é—­
                }
            }

            // ğŸŸ¢ æµç¨‹ï¼šå…³é—­æŠ½å±‰ -> è¿”å›åˆ—è¡¨ (ä¸åŒºåˆ†æ¨¡å¼)
            const closeEditor = () => { 
                isEditing.value = false; 
                editorMode.value = 'view'; 
                saveStatus.value = ''; 
            }
            
            const saveNote = async () => {
                if(!form.title) return alert('Please enter a title'); 
                saveStatus.value = 'Saving...';
                
                if (!quill) {
                    saveStatus.value = 'Error: Editor not initialized.';
                    console.error("Quill not initialized. Cannot save.");
                    return;
                }
                
                const contentStr = quill.root.innerHTML; 
                
                // ğŸŸ¢ ä¿®å¤ 2: å¦‚æœå†…å®¹ä¸ºç©º HTMLï¼Œå¼ºåˆ¶å­˜ä¸ºç©ºå­—ç¬¦ä¸²
                const finalContent = contentStr === '<p><br></p>' ? '' : contentStr;

                const payload = { 
                    user_id: user.value.id, 
                    title: form.title, 
                    content: finalContent, 
                    category: currentCategory.value, 
                    is_public: form.is_public, 
                    // å­˜å‚¨ sub_category: å¦‚æœæ˜¯ 'ä¸»æ–‡æ¡£' åˆ™å­˜ä¸º 'é»˜è®¤'ï¼Œå¦åˆ™å­˜å…¥å®é™…æ ‡ç­¾
                    sub_category: form.sub_category === 'ä¸»æ–‡æ¡£' ? 'é»˜è®¤' : form.sub_category 
                };

                if(form.id) { 
                    delete payload.user_id; 
                    await _supabase.from('notes').update(payload).eq('id', form.id) 
                } else { 
                    const { data } = await _supabase.from('notes').insert(payload).select();
                    if(data && data.length > 0) form.id = data[0].id; 
                } 
                
                saveStatus.value = 'Saved';
                setTimeout(() => saveStatus.value = '', 2000);
                fetchNotes();
                
                // ğŸŸ¢ ä¿®å¤ 5: ä¿å­˜åè‡ªåŠ¨è·³è½¬å›æŸ¥çœ‹æ¨¡å¼
                editorMode.value = 'view';
                initialContentToLoad.value = finalContent; // æ›´æ–°æŸ¥çœ‹å†…å®¹
            }

            const deleteNote = async (id) => { 
                if (!id) return alert('Error: No document ID to delete.');
                if(confirm('Delete this document?')) { 
                    await _supabase.from('notes').delete().eq('id', id); 
                    closeEditor(); 
                    fetchNotes(); 
                } 
            }
            
            const addCategory = () => { 
                const n = prompt("New Tag Name:"); 
                if(n && n.trim() !== '' && !categories[currentCategory.value].includes(n.trim())) {
                    categories[currentCategory.value].push(n.trim());
                    // ç«‹å³å°†æ–°æ ‡ç­¾æ·»åŠ åˆ°å½“å‰æ–‡æ¡£
                    form.sub_category = n.trim();
                }
            }
            
            // ğŸŸ¢ ä¿®å¤ 6: åˆ é™¤æ ‡ç­¾é€»è¾‘
            const deleteCategory = async (tag) => {
                 if (tag === 'å…¨éƒ¨' || tag === 'ä¸»æ–‡æ¡£') return;
                if(confirm(`Confirm deletion of tag "${tag}"?`)) { 
                    // 1. ä» Vue åˆ—è¡¨ä¸­ç§»é™¤
                    const idx = categories[currentCategory.value].indexOf(tag); 
                    if (idx > -1) categories[currentCategory.value].splice(idx, 1);
                    
                    // 2. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ–‡æ¡£ä½¿ç”¨è¯¥æ ‡ç­¾ï¼Œå¹¶å°†å…¶é‡ç½®ä¸º 'é»˜è®¤'
                    const { data, error } = await _supabase.from('notes')
                        .update({ sub_category: 'é»˜è®¤' })
                        .eq('category', currentCategory.value)
                        .eq('sub_category', tag);
                        
                    if (!error) {
                         fetchNotes();
                         // å¦‚æœå½“å‰é€‰ä¸­çš„æ ‡ç­¾è¢«åˆ é™¤äº†ï¼Œåˆ‡æ¢å› 'å…¨éƒ¨'
                         if (currentSub.value === tag) currentSub.value = 'å…¨éƒ¨';
                    } else {
                        console.error("Error updating notes:", error);
                    }
                } 
            }
            
            const getSummary = (content) => {
                if (!content) return 'Empty Doc';
                const tmp = document.createElement("DIV"); 
                tmp.innerHTML = content; 
                return tmp.textContent || tmp.innerText || "Empty Doc";
            }
            const formatTime = (ts) => new Date(ts).toLocaleDateString()

            return { 
                user, notes, currentCategory, currentSub, mobileMenuOpen, isEditing, editorMode, form, saveStatus,
                currentSubCategories, filteredNotes, isDark, toggleTheme,
                createNote, viewNote, closeEditor, saveNote, deleteNote, addCategory, deleteCategory, getSummary, formatTime, switchCategory, startEdit, cancelEdit, initialContentToLoad
            }
        }
    }).mount('#app')
</script>
</body>
</html>