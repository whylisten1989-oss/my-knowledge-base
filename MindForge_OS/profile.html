<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindForge Identity (V4.7)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="css/global.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { 'bg-dark': '#000000', 'bg-light': '#f8fafc' }, fontFamily: { sans: ['"JetBrains Mono"', '"Microsoft YaHei"', 'sans-serif'] } }
            }
        }
    </script>
</head>
<body class="bg-bg-light dark:bg-bg-dark h-screen flex overflow-hidden transition-colors duration-500 text-gray-900 dark:text-gray-200">

<script src="js/config.js"></script>

<div class="fixed inset-0 pointer-events-none z-0 transition-opacity duration-1000">
    <div class="absolute inset-0 opacity-0 dark:opacity-100 transition-opacity duration-1000">
        <div class="absolute top-[-20%] left-[-10%] w-[50vw] h-[50vw] bg-blue-900/10 blur-[150px] rounded-full"></div>
    </div>
</div>

<div id="app" v-cloak class="h-full w-full flex relative z-10">

    <aside :class="['floating-sidebar w-64 flex flex-col justify-between transition-transform duration-300 fixed md:relative z-40', mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0']">
        <div>
            <div class="h-20 flex items-center px-8 border-b border-gray-200 dark:border-white/5">
                <span class="text-xl font-black tracking-tighter text-black dark:text-white cyber-logo">MindForge <span class="text-[10px] opacity-60 ml-1 font-normal">IDENTITY</span></span>
            </div>
            <nav class="p-4 space-y-6">
                <div>
                    <div class="text-[10px] font-bold text-gray-400 dark:text-gray-600 uppercase tracking-widest mb-3 pl-4">Core</div>
                    <a href="index.html" class="nav-item w-full text-left block p-3 mb-1 text-xs">System Home</a>
                    <a href="finance.html" class="nav-item w-full text-left block p-3 text-xs">Finance 金融</a>
                    <button class="nav-item w-full text-left block p-3 text-xs active">Identity 个人中心</button>
                </div>
            </nav>
        </div>
        <div class="p-6 border-t border-gray-200 dark:border-white/5">
            <div class="text-[10px] text-gray-500 font-mono">ID: {{ user?.id?.slice(0,8) }}...</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-transparent relative overflow-hidden w-full pl-4 pt-4 no-scroll-x">
        
        <header class="h-16 flex items-center justify-between px-8 shrink-0 mb-4 mr-4 cyber-card z-50 sticky top-0 bg-white/80 dark:bg-[#0a0a0a]/80 backdrop-blur-xl border border-gray-200 dark:border-white/10 shadow-lg">
            <div class="flex items-center gap-6">
                <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden text-2xl">☰</button>
                <span class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em]">Profile Configuration</span>
            </div>
            <div class="flex items-center gap-4">
                <button @click="toggleTheme" class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 dark:border-white/20 text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 transition">
                    <span v-if="isDark">☀</span><span v-else>☾</span>
                </button>
                <button v-if="isEditing" @click="saveProfile" class="btn-cyber rounded-lg bg-black text-white dark:bg-white dark:text-black">SAVE</button>
                <button v-else @click="isEditing = true" class="btn-cyber rounded-lg text-black dark:text-white border-gray-300 dark:border-white/20">EDIT</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto pr-4 pb-4 relative z-10 custom-scroll">
            <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 pt-4">
                
                <div class="lg:col-span-1 space-y-8">
                    <div class="cyber-card p-10 flex flex-col items-center text-center relative overflow-hidden group">
                        <div class="relative mb-8">
                            <div class="w-32 h-32 rounded-full border-2 border-gray-200 dark:border-white/20 p-1 overflow-hidden relative z-10 bg-gray-100 dark:bg-black">
                                <img :src="profile.avatar" class="w-full h-full object-cover rounded-full grayscale group-hover:grayscale-0 transition duration-500">
                            </div>
                        </div>

                        <div class="w-full space-y-4">
                            <div v-if="isEditing">
                                <label class="text-[9px] text-gray-400 uppercase font-bold block text-left mb-1">Display Name</label>
                                <input v-model="tempProfile.name" class="cyber-input text-center text-lg font-bold">
                            </div>
                            <h1 v-else class="text-3xl font-black text-black dark:text-white tracking-tighter">{{ profile.name }}</h1>

                            <div v-if="isEditing">
                                <label class="text-[9px] text-gray-400 uppercase font-bold block text-left mb-1">Avatar URL</label>
                                <input v-model="tempProfile.avatar" class="cyber-input text-xs text-gray-500">
                            </div>

                            <div v-if="isEditing">
                                <label class="text-[9px] text-gray-400 uppercase font-bold block text-left mb-1">Signature</label>
                                <textarea v-model="tempProfile.bio" class="cyber-input h-24 text-xs"></textarea>
                            </div>
                            <p v-else class="text-sm text-gray-500 dark:text-gray-400 leading-loose font-serif italic border-t border-gray-200 dark:border-white/10 pt-6">
                                "{{ profile.bio }}"
                            </p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <h2 class="text-xl font-black text-black dark:text-white mb-8 flex items-center gap-3">
                        <span class="text-blue-500">///</span> SYSTEM CHANGELOG
                    </h2>
                    
                    <div class="relative pl-6">
                        <div class="absolute left-[23px] top-0 bottom-0 w-[2px] bg-gradient-to-b from-blue-500 to-transparent opacity-20"></div>
                        
                        <div v-if="logs.length === 0" class="text-gray-500 text-xs pl-8">Loading timeline...</div>

                        <div v-for="(log, index) in logs" :key="log.id" class="mb-10 relative pl-8 group">
                            <div :class="['absolute left-0 top-1.5 w-3 h-3 rounded-full border-2 transition-all duration-300 z-10 bg-white dark:bg-black', index === 0 ? 'border-blue-500 shadow-[0_0_10px_#3b82f6] scale-125' : 'border-gray-300 dark:border-gray-600']"></div>
                            
                            <div class="cyber-card p-6 hover:translate-x-2 transition duration-300">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 :class="['text-lg font-bold', index === 0 ? 'text-black dark:text-white' : 'text-gray-600 dark:text-gray-300']">{{ log.title }}</h3>
                                    <span class="text-[10px] font-mono text-gray-400 border border-gray-200 dark:border-white/10 px-2 py-1 rounded">{{ new Date(log.created_at).toLocaleDateString() }}</span>
                                </div>
                                <div class="flex gap-2 mb-4">
                                    <span v-if="log.sub_category" class="text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded bg-blue-500/10 text-blue-500">
                                        {{ log.sub_category }}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed font-mono">
                                    {{ log.content }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

</div>

<script>
    const { createApp, ref, onMounted, reactive, watch } = Vue

    createApp({
        setup() {
            if (!window._supabase) { console.error("Config Error"); return {}; }
            const _supabase = window._supabase; 

            const isDark = ref(true)
            if (localStorage.getItem('theme') === 'light') { isDark.value = false; document.documentElement.classList.remove('dark'); }
            const toggleTheme = () => { isDark.value = !isDark.value; if(isDark.value){document.documentElement.classList.add('dark');localStorage.setItem('theme','dark')}else{document.documentElement.classList.remove('dark');localStorage.setItem('theme','light')} }

            const mobileMenuOpen = ref(false)
            const user = ref(null)
            const profile = reactive({ name: 'User', avatar: '', bio: '' })
            const tempProfile = reactive({ name: '', avatar: '', bio: '' })
            const isEditing = ref(false)
            const logs = ref([])

            watch(isEditing, (val) => { if (val) Object.assign(tempProfile, profile); })

            const fetchProfile = async () => {
                const { data } = await _supabase.from('notes').select('*').eq('category', 'profile').single()
                if (data && data.content) try { Object.assign(profile, JSON.parse(data.content)) } catch(e){}
            }

            const saveProfile = async () => {
                Object.assign(profile, tempProfile);
                const jsonContent = JSON.stringify(profile);
                const { data: existing } = await _supabase.from('notes').select('id').eq('category', 'profile').single();
                if (existing) await _supabase.from('notes').update({ content: jsonContent }).eq('id', existing.id);
                else await _supabase.from('notes').insert({ user_id: user.value.id, title: '__SYSTEM_PROFILE__', content: jsonContent, category: 'profile', is_public: false });
                isEditing.value = false; alert("PROFILE UPDATED");
            }

            const fetchLogs = async () => {
                const { data } = await _supabase.from('notes').select('*').eq('category', 'changelog').order('created_at', { ascending: false });
                if (data) logs.value = data;
            }

            onMounted(async () => {
                const { data: { session } } = await _supabase.auth.getSession()
                if(session) { user.value = session.user; fetchProfile(); fetchLogs(); }
            })

            return { mobileMenuOpen, user, profile, tempProfile, isEditing, logs, saveProfile, isDark, toggleTheme }
        }
    }).mount('#app')
</script>
</body>
</html>