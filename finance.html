<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindForge Finance (V6.4 - Bulletproof)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="css/global.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 'bg-dark': '#000000', 'bg-light': '#f8fafc' },
                    fontFamily: { sans: ['"JetBrains Mono"', '"Microsoft YaHei"', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        [v-cloak] { display: none; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .log-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px; margin-bottom: 4px;
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 11px;
        }
        .dark .log-item { background: rgba(255, 255, 255, 0.03); border-color: rgba(255, 255, 255, 0.05); }
        html:not(.dark) .log-item { background: #fff; border-color: rgba(0, 0, 0, 0.05); }

        .log-icon-box {
            width: 28px; height: 28px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: bold; margin-right: 10px;
        }
        .bg-inc { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .bg-exp { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .bg-inv { background: rgba(59, 130, 246, 0.15); color: #3b82f6; } 

        .view-tab.active::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            width: 20px; height: 2px; background-color: #3b82f6; border-radius: 2px;
        }

        .custom-select-btn {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px; font-size: 12px; font-weight: bold;
            color: white; cursor: pointer; transition: all 0.2s;
        }
        .light .custom-select-btn { background: #f3f4f6; border-color: #e5e7eb; color: #111827; }
    </style>
</head>
<body class="bg-bg-light dark:bg-bg-dark h-screen flex overflow-hidden transition-colors duration-500 text-gray-900 dark:text-gray-200 text-sm">

<script src="js/config.js"></script>

<div id="app" v-cloak class="h-full w-full flex relative z-10 flex-col md:flex-row">

    <aside :class="['floating-sidebar w-64 flex flex-col justify-between transition-transform duration-300 fixed md:relative z-50 h-full bg-bg-light dark:bg-bg-dark border-r border-gray-200 dark:border-white/5', mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0']">
        <div>
            <div class="h-16 md:h-20 flex items-center px-6 md:px-8 border-b border-gray-200 dark:border-white/5">
                <span class="text-lg md:text-xl font-black tracking-tighter text-black dark:text-white cyber-logo">MindForge <span class="text-[10px] opacity-60 ml-1 font-normal">FINANCE</span></span>
            </div>
            <nav class="p-4 space-y-2">
                <a href="index.html" class="nav-item w-full text-left block p-3 mb-1 text-xs">System Home</a>
                <button class="nav-item w-full text-left block p-3 text-xs active">Finance ÈáëËûç</button>
                <a href="habits.html" class="nav-item w-full text-left block p-3 text-xs">Habits ‰π†ÊÉØ</a>
            </nav>
        </div>
        <button @click="mobileMenuOpen = false" class="md:hidden absolute top-4 right-4 text-gray-400 p-2">‚úï</button>
    </aside>

    <main class="flex-1 flex flex-col bg-transparent relative w-full px-2 md:pl-4 md:pt-4 no-scroll-x h-full">
        
        <header class="h-14 md:h-16 flex items-center justify-between px-4 md:px-8 shrink-0 mb-2 md:mb-4 md:mr-4 cyber-card z-[100] sticky top-2 md:top-0 bg-white/90 dark:bg-[#0a0a0a]/90 backdrop-blur-xl border border-gray-200 dark:border-white/10 shadow-lg !overflow-visible">
            <div class="flex items-center gap-3 md:gap-6">
                <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden text-xl">‚ò∞</button>
                <div class="flex flex-col relative justify-center">
                    <span class="text-[8px] md:text-[9px] font-bold text-gray-500 uppercase tracking-[0.1em] md:tracking-[0.2em] mb-0.5">Financial Intelligence</span>
                    <div class="relative z-[100]">
                        <div v-if="currentView === 'cashflow'">
                            <button @click="showMonthPicker = !showMonthPicker" class="month-trigger-btn text-black dark:text-white text-xs font-bold">
                                <span>{{ selectedYear }}</span><span class="text-gray-400">.</span><span>{{ selectedMonth < 10 ? '0'+selectedMonth : selectedMonth }}</span><span class="text-[8px] text-gray-400 ml-1">‚ñº</span>
                            </button>
                            <div v-if="showMonthPicker" class="absolute top-full left-0 mt-2 w-48 p-2 bg-white/95 dark:bg-[#0a0a0a]/95 border border-gray-200 dark:border-white/20 rounded-xl shadow-xl z-[100]">
                                <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-200 dark:border-white/10">
                                    <button @click="selectedYear--" class="px-2">‚óÄ</button>
                                    <span class="font-bold">{{ selectedYear }}</span>
                                    <button @click="selectedYear++" class="px-2">‚ñ∂</button>
                                </div>
                                <div class="grid grid-cols-4 gap-1">
                                    <button v-for="m in 12" :key="m" @click="setMonth(m)" :class="['text-[10px] py-1 rounded border', selectedMonth == m ? 'bg-black text-white dark:bg-white dark:text-black' : 'border-transparent']">{{ m }}</button>
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-xs font-bold text-black dark:text-white">PORTFOLIO COMMAND</div>
                    </div>
                </div>
            </div>
            
            <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex gap-1 p-0.5 md:p-1 bg-gray-100 dark:bg-white/5 rounded-lg border border-gray-200 dark:border-white/10 scale-90 md:scale-100">
                <button @click="switchView('cashflow')" :class="['px-3 py-1 text-[10px] font-bold uppercase rounded', currentView === 'cashflow' ? 'bg-white dark:bg-[#0a0a0a] shadow-sm' : 'text-gray-400']">Cash</button>
                <button @click="switchView('portfolio')" :class="['px-3 py-1 text-[10px] font-bold uppercase rounded', currentView === 'portfolio' ? 'bg-white dark:bg-[#0a0a0a] shadow-sm' : 'text-gray-400']">Stock</button>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <button @click="togglePrivacy" class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 dark:border-white/20 text-gray-500 hover:text-blue-500 transition" title="Privacy Mode">
                    <span>{{ privacyMode ? 'üôà' : 'üëÅÔ∏è' }}</span>
                </button>
                <button @click="toggleTheme" class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 dark:border-white/20 text-gray-500">
                    <span v-if="isDark">‚òÄ</span><span v-else>‚òæ</span>
                </button>
                <button v-if="currentView === 'cashflow'" @click="openAddModal" class="btn-cyber text-black dark:text-white border-gray-300 dark:border-white/20 rounded-lg hover:bg-black hover:text-white dark:hover:bg-white dark:hover:text-black px-3 py-1 text-xs">
                    +
                </button>
                <button v-else @click="openAssetModal" class="btn-cyber text-blue-500 border-blue-500/30 rounded-lg hover:bg-blue-500 hover:text-white px-3 py-1 text-xs">
                    +
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto pr-2 md:pr-4 pb-4 relative z-10 custom-scroll">
            
            <div v-if="currentView === 'cashflow'" class="w-full space-y-4 md:space-y-6 animate-fade-in pt-2">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 md:gap-6">
                    <div class="lg:col-span-1 cyber-card p-6 md:p-8 flex flex-col justify-center bg-gradient-to-br from-blue-50/50 to-white dark:from-blue-900/20 dark:to-transparent">
                        <div class="text-[10px] text-blue-500 font-bold uppercase tracking-widest mb-2">Lifetime Net Worth</div>
                        <div class="text-2xl md:text-4xl font-black text-black dark:text-white tracking-tight font-mono truncate">¬• {{ nFormatter(lifetimeStats.net) }}</div>
                    </div>
                    <div class="lg:col-span-3 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                        <div class="cyber-card p-4 flex flex-col justify-center">
                            <div class="text-[9px] text-gray-500 uppercase tracking-widest mb-1">Income</div>
                            <div class="text-base md:text-lg font-bold text-green-600 dark:text-green-400 truncate">+{{ nFormatter(currentMonthStats.income) }}</div>
                        </div>
                        <div class="cyber-card p-4 flex flex-col justify-center">
                            <div class="text-[9px] text-gray-500 uppercase tracking-widest mb-1">Expense</div>
                            <div class="text-base md:text-lg font-bold text-red-500 dark:text-red-400 truncate">-{{ nFormatter(currentMonthStats.expense) }}</div>
                        </div>
                        <div class="cyber-card p-4 flex flex-col justify-center">
                            <div class="text-[9px] text-gray-500 uppercase tracking-widest mb-1">Net</div>
                            <div class="text-base md:text-lg font-bold text-black dark:text-white truncate">{{ nFormatter(currentMonthStats.net) }}</div>
                        </div>
                        <div class="cyber-card p-4 flex flex-col justify-center relative">
                            <div class="text-[9px] text-gray-500 uppercase tracking-widest mb-1">Savings Rate</div>
                            <div :class="['text-xl md:text-2xl font-black z-10', savingsRate >= 50 ? 'text-green-600' : 'text-blue-500']">{{ savingsRate }}%</div>
                            <div class="absolute bottom-0 left-0 h-1 bg-gray-200 dark:bg-white/5 w-full"><div class="h-full transition-all duration-1000" :style="{ width: Math.max(0, Math.min(100, savingsRate)) + '%', backgroundColor: savingsRate >= 50 ? '#10b981' : '#3b82f6' }"></div></div>
                        </div>
                    </div>
                </div>

                <div class="cyber-card p-4 md:p-6 h-64 md:h-80 flex flex-col">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Daily Trend [{{ selectedMonth }}Êúà]</h3>
                    <div id="chart-daily" class="flex-1 w-full"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 h-auto">
                    <div class="lg:col-span-2 grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                        <div class="cyber-card p-4 md:p-6 flex flex-col h-64 md:h-80">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Savings Trend</h3>
                            <div id="chart-history" class="flex-1 w-full"></div>
                        </div>
                        <div class="cyber-card p-4 md:p-6 flex flex-col h-64 md:h-80">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Structure</h3>
                            <div id="chart-pie" class="flex-1 w-full"></div>
                        </div>
                    </div>
                    
                    <div class="cyber-card flex-1 flex flex-col overflow-hidden h-[20rem]">
                        <div class="p-4 border-b border-gray-200 dark:border-white/5 flex justify-between items-center bg-gray-50 dark:bg-black/20">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Cashflow Log</h3>
                            <span class="text-[10px] font-mono text-gray-400">{{ filteredTransactions.length }} ITEMS</span>
                        </div>
                        <div class="overflow-y-auto flex-1 p-3 custom-scroll">
                            <div v-for="item in reversedFilteredTransactions" :key="item.id" class="log-item group">
                                <div class="flex items-center">
                                    <div :class="['log-icon-box', item.type === 'expense' ? 'bg-exp' : 'bg-inc']">
                                        {{ item.type === 'expense' ? 'OUT' : 'IN' }}
                                    </div>
                                    <div>
                                        <div class="text-xs font-bold text-black dark:text-white mb-0.5">{{ safeTitle(item.title) }}</div>
                                        <div class="text-[9px] text-gray-400 font-mono flex items-center gap-2">
                                            <span>{{ item.date }}</span>
                                            <span class="uppercase">[{{ item.category }}]</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div :class="['text-xs font-mono font-bold', item.type === 'expense' ? 'text-red-500 dark:text-red-400' : 'text-green-600 dark:text-green-400']">
                                        {{ item.type === 'expense' ? '-' : '+' }}{{ nFormatter(item.amount) }}
                                    </div>
                                    <button @click="deleteTransaction(item.id)" class="text-[9px] text-gray-400 hover:text-red-500 font-bold opacity-0 group-hover:opacity-100 transition mt-1 uppercase">DEL</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="w-full h-full flex flex-col gap-4 md:gap-6 animate-fade-in pt-2">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                    <div class="cyber-card p-6 md:p-8 relative overflow-hidden group col-span-1 flex flex-col justify-center">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-900/10 to-purple-900/10 z-0"></div>
                        <div class="relative z-10">
                            <div class="text-[10px] text-blue-500 font-bold uppercase tracking-widest mb-3">Current Book Value [ÂΩìÂâçÊåÅ‰ªì]</div>
                            <div class="text-3xl font-black text-black dark:text-white tracking-tight font-mono mb-1">¬• {{ nFormatter(investmentStats.currentBookValue) }}</div>
                            <div class="text-[10px] text-gray-400">Assets deployed in market</div>
                        </div>
                    </div>
                    
                    <div class="cyber-card p-4 md:p-6 col-span-1 lg:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-3 bg-gray-50 dark:bg-white/5 rounded-lg border border-transparent hover:border-gray-200 dark:hover:border-white/10 transition">
                            <div class="text-[9px] text-gray-500 uppercase tracking-widest mb-2">Lifetime P&L [ÊÄªÁõà‰∫è]</div>
                            <div :class="['text-xl font-bold font-mono', investmentStats.gains >= 0 ? 'text-green-500' : 'text-red-500']">
                                {{ investmentStats.gains >= 0 ? '+' : '' }}{{ nFormatter(investmentStats.gains) }}
                            </div>
                            <div class="text-[9px] font-mono opacity-60 mt-1">ROI: [{{ investmentStats.roi }}%]</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-white/5 rounded-lg border border-transparent hover:border-gray-200 dark:hover:border-white/10 transition">
                            <div class="text-[9px] text-gray-500 uppercase tracking-widest mb-2">Win Rate [ËÉúÁéá]</div>
                            <div class="text-xl font-bold text-blue-500 font-mono">{{ investmentStats.winRate }}%</div>
                            <div class="text-[9px] font-mono opacity-60 mt-1">Trade Efficiency</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-white/5 rounded-lg border border-transparent hover:border-gray-200 dark:hover:border-white/10 transition">
                            <div class="text-[9px] text-gray-500 uppercase tracking-widest mb-2">Best Trade [ÊúÄ‰Ω≥]</div>
                            <div class="text-xs font-bold text-green-500 line-clamp-1" :title="investmentStats.bestTrade">{{ safeTitle(investmentStats.bestTrade).split('|')[0] || '--' }}</div>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-[10px] font-mono text-black dark:text-white">{{ nFormatter(investmentStats.bestTradeVal) }}</span>
                                <span v-if="investmentStats.bestTradeRoi" class="text-[8px] px-1 rounded bg-green-500/20 text-green-500 font-bold">[{{ investmentStats.bestTradeRoi }}%]</span>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-white/5 rounded-lg border border-transparent hover:border-gray-200 dark:hover:border-white/10 transition">
                            <div class="text-[9px] text-gray-500 uppercase tracking-widest mb-2">Worst Trade [ÊúÄÂ∑Æ]</div>
                            <div class="text-xs font-bold text-red-500 line-clamp-1" :title="investmentStats.worstTrade">{{ safeTitle(investmentStats.worstTrade).split('|')[0] || '--' }}</div>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-[10px] font-mono text-black dark:text-white">{{ nFormatter(investmentStats.worstTradeVal) }}</span>
                                <span v-if="investmentStats.worstTradeRoi" class="text-[8px] px-1 rounded bg-red-500/20 text-red-500 font-bold">[{{ investmentStats.worstTradeRoi }}%]</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 min-h-[400px]">
                    
                    <div class="cyber-card p-4 md:p-6 flex flex-col h-80 lg:h-80">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Monthly P&L [ÊúàÂ∫¶Áõà‰∫è]</h3>
                        <div id="chart-stock-trend" class="flex-1 w-full"></div>
                    </div>

                    <div class="cyber-card p-4 md:p-6 flex flex-col lg:col-span-2 h-80 lg:h-80">
                         <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Asset Allocation [ËµÑ‰∫ßÂàÜÂ∏É]</h3>
                         <div class="flex flex-col md:flex-row h-full items-start">
                             <div id="chart-stock-allocation" class="h-48 md:h-full w-full md:w-1/3"></div>
                             
                             <div class="w-full md:w-2/3 border-t md:border-t-0 md:border-l border-gray-200 dark:border-white/10 pt-4 md:pt-0 md:pl-6 flex flex-col h-full">
                                 <div class="flex justify-between text-[9px] text-gray-400 uppercase tracking-widest mb-2 border-b border-gray-200 dark:border-white/10 pb-1">
                                     <span>Asset Name</span>
                                     <span class="text-right">Value / Alloc</span>
                                 </div>
                                 <div class="flex-1 overflow-y-auto custom-scroll pr-2">
                                     <div v-if="currentHoldings.length === 0" class="text-xs text-gray-500 italic py-2">No active positions</div>
                                     <div v-for="h in sortedHoldings" :key="h.name" class="flex justify-between items-center mb-3 group hover:bg-gray-50 dark:hover:bg-white/5 p-1 rounded transition">
                                         <div class="flex items-center gap-3">
                                             <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                             <div class="flex flex-col">
                                                 <span class="text-xs font-bold text-black dark:text-white">{{ h.name }}</span>
                                                 <span class="text-[9px] text-gray-500">{{ investmentStats.currentBookValue > 0 ? ((h.cost / investmentStats.currentBookValue)*100).toFixed(1) : '0.0' }}% Alloc</span>
                                             </div>
                                         </div>
                                         <div class="text-right flex flex-col">
                                             <span class="text-xs font-mono font-bold text-black dark:text-white">¬•{{ nFormatter(h.cost) }}</span>
                                             <span class="text-[9px] text-gray-400 font-mono">COST BASIS</span>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>

                    <div class="cyber-card flex flex-col overflow-hidden h-60 lg:h-60 lg:col-span-3">
                        <div class="p-4 border-b border-gray-200 dark:border-white/5 flex justify-between items-center bg-blue-50/50 dark:bg-blue-900/10">
                            <h3 class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest">Live Transaction Stream</h3>
                            <span class="text-[10px] font-mono text-blue-400">HISTORY</span>
                        </div>
                        <div class="overflow-y-auto flex-1 p-3 custom-scroll">
                            <div v-if="visibleInvestmentLogs.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-50">
                                <div class="text-xs font-mono">No history</div>
                            </div>
                            <div v-for="item in visibleInvestmentLogs" :key="item.id" class="log-item group">
                                <div class="flex items-center">
                                    <div :class="['log-icon-box', item.type === 'expense' && item.category === 'ÊäïËµÑ' ? 'bg-inv' : (item.type === 'income' ? 'bg-inc' : 'bg-exp')]">
                                        {{ safeTitle(item.title).startsWith('Buy') ? 'BUY' : 'SELL' }}
                                    </div>
                                    <div>
                                        <div class="text-xs font-bold text-black dark:text-white mb-0.5 line-clamp-1">{{ safeTitle(item.title).replace(/Buy: |Sell: |Loss: /, '') }}</div>
                                        <div class="text-[9px] text-gray-400 font-mono flex items-center gap-2">
                                            <span>{{ formatDateTime(item.created_at) }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div :class="['text-xs font-mono font-bold', item.type === 'income' ? 'text-green-500' : (item.category==='ÁêÜË¥¢‰∫èÊçü' ? 'text-red-500' : 'text-black dark:text-white')]">
                                        {{ item.category==='ÁêÜË¥¢‰∫èÊçü' ? '-' : (item.type==='income' ? '+' : '') }}{{ nFormatter(item.amount) }}
                                    </div>
                                    <button @click="deleteTransaction(item.id)" class="text-[9px] text-gray-400 hover:text-red-500 font-bold opacity-0 group-hover:opacity-100 transition mt-1 uppercase">REV</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <div v-if="showModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 dark:bg-black/90 p-4 backdrop-blur-md animate-fade-in">
        <div class="cyber-card w-full max-w-md p-6 md:p-8 shadow-2xl relative bg-white dark:bg-[#0a0a0a]">
            <button @click="showModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-black dark:hover:text-white">‚úï</button>
            <h2 class="text-xl font-black text-black dark:text-white mb-6 tracking-tighter">NEW ENTRY [CASHFLOW]</h2>
            <div class="space-y-4">
                <div class="flex p-1 bg-gray-100 dark:bg-black/50 rounded-lg border border-gray-200 dark:border-white/10">
                    <button @click="form.type = 'expense'" :class="['flex-1 py-2 text-xs font-bold transition uppercase tracking-wider rounded-md', form.type === 'expense' ? 'bg-white dark:bg-red-900/20 text-red-500 border border-gray-200 dark:border-red-500/30 shadow-sm' : 'text-gray-400 hover:text-black dark:hover:text-white']">Expense</button>
                    <button @click="form.type = 'income'" :class="['flex-1 py-2 text-xs font-bold transition uppercase tracking-wider rounded-md', form.type === 'income' ? 'bg-white dark:bg-green-900/20 text-green-500 border border-gray-200 dark:border-green-500/30 shadow-sm' : 'text-gray-400 hover:text-black dark:hover:text-white']">Income</button>
                </div>
                <div class="space-y-1"><label class="text-[9px] text-gray-400 uppercase font-bold pl-1">Amount</label><input v-model="form.amount" type="number" placeholder="0.00" class="cyber-input"></div>
                <div class="space-y-1"><label class="text-[9px] text-gray-400 uppercase font-bold pl-1">Title</label><input v-model="form.title" type="text" placeholder="Detail..." class="cyber-input"></div>
                <div class="space-y-1">
                    <label class="text-[9px] text-gray-400 uppercase font-bold pl-1">Date</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1"><select v-model="formYear" class="cyber-input p-2 text-xs text-center cursor-pointer appearance-none"><option v-for="y in 5" :key="y" :value="2023 + y">{{ 2023 + y }}</option></select></div>
                        <div class="relative flex-1"><select v-model="formMonth" class="cyber-input p-2 text-xs text-center cursor-pointer appearance-none"><option v-for="m in 12" :key="m" :value="m">{{ m }}Êúà</option></select></div>
                        <div class="relative flex-1"><select v-model="formDay" class="cyber-input p-2 text-xs text-center cursor-pointer appearance-none"><option v-for="d in daysInFormMonth" :key="d" :value="d">{{ d }}Êó•</option></select></div>
                    </div>
                </div>
                <div class="space-y-1"><label class="text-[9px] text-gray-400 uppercase font-bold pl-1">Category</label><div class="grid grid-cols-4 gap-2"><button v-for="cat in currentCategories" :key="cat" @click="form.category = cat" :class="['py-2 text-[9px] font-bold border transition uppercase rounded-md', form.category === cat ? 'bg-black text-white dark:bg-white dark:text-black border-transparent' : 'bg-transparent text-gray-400 border-gray-200 dark:border-white/10 hover:border-black dark:hover:border-white/40 hover:text-black dark:hover:text-white']">{{ cat }}</button></div></div>
            </div>
            <div class="flex gap-4 mt-8"><button @click="saveTransaction" class="flex-1 btn-cyber rounded-lg w-full bg-black text-white dark:bg-white dark:text-black">CONFIRM</button></div>
        </div>
    </div>

    <div v-if="showAssetModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 dark:bg-black/90 p-4 backdrop-blur-md animate-fade-in">
        <div class="cyber-card w-full max-w-md p-6 md:p-8 shadow-2xl relative bg-white dark:bg-[#0a0a0a] border border-blue-500/30">
            <button @click="showAssetModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-black dark:hover:text-white">‚úï</button>
            <h2 class="text-xl font-black text-blue-600 dark:text-blue-500 mb-6 tracking-tighter">STOCK TRANSACTION</h2>
            
            <div class="space-y-5">
                <div class="flex p-1 bg-gray-100 dark:bg-black/50 rounded-lg border border-gray-200 dark:border-white/10">
                    <button @click="assetForm.action = 'buy'; resetAssetForm()" :class="['flex-1 py-2 text-xs font-bold transition uppercase tracking-wider rounded-md', assetForm.action === 'buy' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:text-black dark:hover:text-white']">Buy (‰π∞ÂÖ•)</button>
                    <button @click="assetForm.action = 'sell'; resetAssetForm()" :class="['flex-1 py-2 text-xs font-bold transition uppercase tracking-wider rounded-md', assetForm.action === 'sell' ? 'bg-green-600 text-white shadow-lg' : 'text-gray-400 hover:text-black dark:hover:text-white']">Sell (ÂçñÂá∫)</button>
                </div>

                <div v-if="assetForm.action === 'buy'" class="animate-fade-in grid grid-cols-3 gap-2">
                    <div class="col-span-1 space-y-1">
                        <label class="text-[9px] text-gray-400 uppercase font-bold pl-1">Code</label>
                        <input v-model="assetForm.code" type="text" placeholder="00700" class="cyber-input font-bold text-center">
                    </div>
                    <div class="col-span-2 space-y-1">
                        <label class="text-[9px] text-gray-400 uppercase font-bold pl-1">Name</label>
                        <input v-model="assetForm.name" type="text" placeholder="Tencent" class="cyber-input font-bold">
                    </div>
                </div>

                <div v-else class="space-y-1 animate-fade-in relative">
                    <label class="text-[9px] text-gray-400 uppercase font-bold pl-1">Select Holding [ÈÄâÊã©ÊåÅ‰ªì]</label>
                    <div class="relative">
                        <button @click="showHoldingPicker = !showHoldingPicker" class="custom-select-btn">
                            <span>{{ selectedHolding ? selectedHolding.name : 'Select from Portfolio...' }}</span>
                            <span class="text-[9px] opacity-60">‚ñº</span>
                        </button>
                        <div v-if="showHoldingPicker" class="absolute top-full left-0 mt-2 w-full max-h-48 overflow-y-auto p-1 bg-white/95 dark:bg-[#0a0a0a]/95 border border-gray-200 dark:border-white/20 rounded-xl shadow-2xl backdrop-blur-xl z-[70] animate-fade-in custom-scroll">
                            <div v-if="currentHoldings.length === 0" class="p-3 text-center text-[10px] text-gray-500">No Holdings Available</div>
                            <button v-for="h in currentHoldings" :key="h.name" @click="selectHoldingItem(h)" class="w-full text-left p-3 text-xs hover:bg-gray-100 dark:hover:bg-white/10 rounded-lg flex justify-between group">
                                <span class="font-bold">{{ h.name }}</span>
                                <span class="font-mono text-gray-500 group-hover:text-black dark:group-hover:text-white">Cost: ¬•{{ nFormatter(h.cost) }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-[9px] text-gray-400 uppercase font-bold pl-1">{{ assetForm.action === 'buy' ? 'Total Cost (¬•)' : 'Total Sell Amount (¬•)' }}</label>
                    <input v-model="assetForm.amount" type="number" placeholder="Total Value" class="cyber-input text-lg">
                </div>
                
                <div v-if="assetForm.action === 'sell' && selectedHolding && assetForm.amount" class="space-y-2 animate-fade-in p-3 bg-gray-50 dark:bg-white/5 rounded border border-gray-200 dark:border-white/10">
                    <div class="flex justify-between text-[10px]">
                        <span class="text-gray-500">Original Cost [ÊàêÊú¨]:</span>
                        <span class="font-mono">¬•{{ nFormatter(selectedHolding.cost) }}</span>
                    </div>
                    <div class="flex justify-between text-[10px]">
                        <span class="text-gray-500">Profit/Loss [Áõà‰∫è]:</span>
                        <span :class="['font-bold font-mono', (assetForm.amount - selectedHolding.cost) >= 0 ? 'text-green-500' : 'text-red-500']">
                            {{ (assetForm.amount - selectedHolding.cost) >= 0 ? '+' : '' }}{{ nFormatter(assetForm.amount - selectedHolding.cost) }}
                        </span>
                    </div>
                     <div class="flex justify-between text-[10px]">
                        <span class="text-gray-500">Return Rate [Êî∂ÁõäÁéá]:</span>
                        <span :class="['font-bold font-mono', (assetForm.amount - selectedHolding.cost) >= 0 ? 'text-green-500' : 'text-red-500']">
                            [{{ ((assetForm.amount - selectedHolding.cost) / selectedHolding.cost * 100).toFixed(2) }}%]
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button @click="saveAssetTransaction" class="flex-1 btn-cyber rounded-lg w-full bg-blue-600 text-white hover:bg-blue-700 border-transparent">
                    CONFIRM {{ assetForm.action.toUpperCase() }}
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, reactive, computed, watch, nextTick } = Vue

    createApp({
        setup() {
            if (!window._supabase) { console.error("Config Error"); return {}; }
            const _supabase = window._supabase; 

            const isDark = ref(true)
            if (localStorage.getItem('theme') === 'light') { isDark.value = false; document.documentElement.classList.remove('dark'); }
            const toggleTheme = () => { isDark.value = !isDark.value; if(isDark.value){document.documentElement.classList.add('dark');localStorage.setItem('theme','dark')}else{document.documentElement.classList.remove('dark');localStorage.setItem('theme','light')} }

            const privacyMode = ref(false)
            const togglePrivacy = () => privacyMode.value = !privacyMode.value

            const currentView = ref('cashflow')
            const switchView = (view) => { 
                currentView.value = view; 
                setTimeout(() => updateAllCharts(), 200);
            }

            const mobileMenuOpen = ref(false)
            const showModal = ref(false)
            const showAssetModal = ref(false)
            const showMonthPicker = ref(false)
            const showHoldingPicker = ref(false)
            const transactions = ref([])
            
            const now = new Date()
            const selectedYear = ref(now.getFullYear())
            const selectedMonth = ref(now.getMonth() + 1)
            const formYear = ref(now.getFullYear())
            const formMonth = ref(now.getMonth() + 1)
            const formDay = ref(now.getDate())

            const daysInFormMonth = computed(() => new Date(formYear.value, formMonth.value, 0).getDate())
            watch([formYear, formMonth], () => { const max = new Date(formYear.value, formMonth.value, 0).getDate(); if(formDay.value > max) formDay.value = max; })

            const expenseCategories = ['È§êÈ•Æ', '‰∫§ÈÄö', 'Ë¥≠Áâ©', 'Â®±‰πê', 'ÊäïËµÑ', 'ÂÇ®ËìÑ', 'ÁêÜË¥¢', 'Âõ∫ÂÆö']
            const incomeCategories = ['Â∑•ËµÑ', 'ÂÖºËÅå', 'ÁêÜË¥¢Êî∂Áõä', 'Â•ñÈáë', 'ÂÖ∂‰ªñ']
            
            const form = reactive({ type: 'expense', amount: '', title: '', category: '' })
            const assetForm = reactive({ action: 'buy', name: '', code: '', amount: '' })
            const selectedHolding = ref(null)

            const currentCategories = computed(() => form.type === 'expense' ? expenseCategories : incomeCategories)
            const currentMonthKey = computed(() => `${selectedYear.value}-${selectedMonth.value < 10 ? '0'+selectedMonth.value : selectedMonth.value}`)
            const filteredTransactions = computed(() => transactions.value.filter(t => t.date.startsWith(currentMonthKey.value)))
            const reversedFilteredTransactions = computed(() => [...filteredTransactions.value].reverse())
            
            // ÂÆâÂÖ®ÁöÑÊ†áÈ¢òÂ§ÑÁêÜÂáΩÊï∞ (Èò≤Ê≠¢ null Â¥©Ê∫É)
            const safeTitle = (t) => {
                return t ? String(t) : 'Unknown';
            }

            const investmentTransactions = computed(() => {
                return transactions.value.filter(t => 
                    t.category === 'ÊäïËµÑ' || t.category === 'ÁêÜË¥¢Êî∂Áõä' || t.category === 'ÁêÜË¥¢‰∫èÊçü'
                ).sort((a,b) => new Date(b.created_at || b.date) - new Date(a.created_at || a.date)) 
            })

            const visibleInvestmentLogs = computed(() => {
                return investmentTransactions.value.filter(t => safeTitle(t.title) && !safeTitle(t.title).startsWith('Principal:'))
            })

            // Ê†∏ÂøÉÈÄªËæë: ËÆ°ÁÆóÊåÅ‰ªì
            const currentHoldings = computed(() => {
                const map = {}; 
                transactions.value.filter(t => t.type === 'expense' && t.category === 'ÊäïËµÑ').forEach(t => {
                    let name = safeTitle(t.title).replace('Buy: ', '').trim();
                    map[name] = (map[name] || 0) + Number(t.amount);
                });
                transactions.value.filter(t => t.type === 'income' && t.category === 'ÊäïËµÑ').forEach(t => {
                    let name = safeTitle(t.title).replace('Principal: ', '').trim();
                    if(map[name]) map[name] -= Number(t.amount);
                });
                transactions.value.filter(t => t.type === 'expense' && t.category === 'ÁêÜË¥¢‰∫èÊçü').forEach(t => {
                    let name = safeTitle(t.title).replace('Loss: ', '').trim();
                    if(map[name]) map[name] -= Number(t.amount); 
                });

                return Object.keys(map).filter(k => map[k] > 1).map(k => ({ name: k, cost: map[k] }));
            });

            const sortedHoldings = computed(() => {
                return [...currentHoldings.value].sort((a,b) => b.cost - a.cost);
            });

            const topHoldings = computed(() => {
                return [...currentHoldings.value].sort((a,b) => b.cost - a.cost).slice(0, 3);
            });

            const investmentStats = computed(() => {
                const invested = investmentTransactions.value.filter(t => t.type === 'expense' && t.category === 'ÊäïËµÑ').reduce((s,t) => s + Number(t.amount), 0)
                const gains = investmentTransactions.value.filter(t => t.type === 'income' && t.category === 'ÁêÜË¥¢Êî∂Áõä').reduce((s,t) => s + Number(t.amount), 0)
                const losses = investmentTransactions.value.filter(t => t.category === 'ÁêÜË¥¢‰∫èÊçü').reduce((s,t) => s + Number(t.amount), 0)
                
                const netGains = gains - losses;
                const winningTrades = investmentTransactions.value.filter(t => t.category === 'ÁêÜË¥¢Êî∂Áõä').length;
                const losingTrades = investmentTransactions.value.filter(t => t.category === 'ÁêÜË¥¢‰∫èÊçü').length;
                const totalClosedTrades = winningTrades + losingTrades;
                const winRate = totalClosedTrades > 0 ? ((winningTrades / totalClosedTrades) * 100).toFixed(0) : '0';

                let bestTrade = '', bestVal = 0, bestTradeRoi = '';
                let worstTrade = '', worstVal = 0, worstTradeRoi = '';

                investmentTransactions.value.forEach(t => {
                    const val = Number(t.amount);
                    if (t.category === 'ÁêÜË¥¢Êî∂Áõä' && val > bestVal) { 
                        bestVal = val; 
                        bestTrade = safeTitle(t.title).replace('Sell: ', '');
                        const principal = investmentTransactions.value.find(p => p.date === t.date && p.title === `Principal: ${bestTrade}`);
                        if(principal && Number(principal.amount) > 0) bestTradeRoi = (val / Number(principal.amount) * 100).toFixed(1);
                    }
                    if (t.category === 'ÁêÜË¥¢‰∫èÊçü' && val > worstVal) { 
                        worstVal = val; 
                        worstTrade = safeTitle(t.title).replace('Loss: ', '');
                        const principal = investmentTransactions.value.find(p => p.date === t.date && p.title === `Principal: ${worstTrade}`);
                        if(principal && Number(principal.amount) > 0) worstTradeRoi = (-val / (Number(principal.amount) + val) * 100).toFixed(1);
                    }
                });

                const currentBookValue = currentHoldings.value.reduce((s, h) => s + h.cost, 0);

                return { currentBookValue, gains: netGains, roi: invested > 0 ? ((netGains / invested) * 100).toFixed(1) : '0.0', winRate, bestTrade, bestTradeVal: bestVal, bestTradeRoi, worstTrade, worstTradeVal: worstVal, worstTradeRoi }
            })
            
            const lifetimeStats = computed(() => {
                const inc = transactions.value.filter(t => t.type === 'income').reduce((s, t) => s + Number(t.amount), 0)
                const exp = transactions.value.filter(t => t.type === 'expense').reduce((s, t) => s + Number(t.amount), 0)
                return { income: inc, expense: exp, net: inc - exp }
            })
            const currentMonthStats = computed(() => {
                const inc = filteredTransactions.value.filter(t => t.type === 'income').reduce((s, t) => s + Number(t.amount), 0)
                const exp = filteredTransactions.value
                    .filter(t => t.type === 'expense' && t.category !== 'ÊäïËµÑ')
                    .reduce((s, t) => s + Number(t.amount), 0)
                return { income: inc, expense: exp, net: inc - exp }
            })
            const savingsRate = computed(() => {
                const inc = currentMonthStats.value.income
                if (inc === 0) return 0
                return (((inc - currentMonthStats.value.expense) / inc) * 100).toFixed(1)
            })

            const nFormatter = (num) => {
                if (privacyMode.value) return '****';
                if (!num && num !== 0) return '0.00';
                return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            }

            const formatDateTime = (isoString) => {
                if(!isoString) return '';
                const d = new Date(isoString);
                if(isNaN(d.getTime())) return isoString; 
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
            }

            let dailyChart = null, historyChart = null, pieChart = null;
            let stockTrendChart = null, stockAllocChart = null;

            const updateDailyChart = () => {
                const el = document.getElementById('chart-daily'); if (!el) return; if (dailyChart) dailyChart.dispose(); dailyChart = echarts.init(el);
                const data = filteredTransactions.value; 
                const daysInMonth = new Date(selectedYear.value, selectedMonth.value, 0).getDate(); 
                const days = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString()); 
                const dailyTotal = new Array(daysInMonth).fill(0);
                const categorySeries = {};

                data.filter(t => t.type === 'expense').forEach(t => { 
                    if (t.category !== 'ÂÇ®ËìÑ' && t.category !== 'ÊäïËµÑ') { 
                        const dayIndex = parseInt(t.date.split('-')[2]) - 1; 
                        const val = Number(t.amount);
                        dailyTotal[dayIndex] += val;
                        if(!categorySeries[t.category]) categorySeries[t.category] = new Array(daysInMonth).fill(0);
                        categorySeries[t.category][dayIndex] += val;
                    } 
                });

                const isDarkTheme = document.documentElement.classList.contains('dark'); 
                const axisColor = isDarkTheme ? '#333' : '#e5e7eb'; const textColor = isDarkTheme ? '#666' : '#9ca3af';
                
                const series = [{ 
                    name: 'TOTAL', type: 'line', data: dailyTotal, smooth: true, 
                    lineStyle: { width: 3, color: '#3b82f6' }, areaStyle: { opacity: 0.2, color: '#3b82f6' }, 
                    label: { show: true, position: 'top', color: textColor, formatter: (p) => p.value > 0 ? p.value : '' } 
                }];
                const colors = ['#f97316', '#10b981', '#ec4899', '#8b5cf6', '#eab308']; let cIdx = 0;
                Object.entries(categorySeries).forEach(([cat, vals]) => { 
                    series.push({ 
                        name: cat, type: 'line', data: vals, smooth: true, 
                        lineStyle: { width: 1.5, type: 'dashed' }, itemStyle: { color: colors[cIdx++ % colors.length] }, 
                        label: { show: false } 
                    }) 
                });

                dailyChart.setOption({ 
                    backgroundColor: 'transparent', tooltip: { trigger: 'axis', confine: true }, 
                    legend: { bottom: 0, icon: 'roundRect', itemGap: 15, textStyle: { color: textColor } },
                    grid: { top: 30, right: 0, bottom: 40, left: 0 }, 
                    xAxis: { type: 'category', data: days, axisLine: { lineStyle: { color: axisColor } }, axisLabel: { color: textColor } }, 
                    yAxis: { type: 'value', show: false }, 
                    series: series 
                }, true);
            }

            const updateHistoryChart = () => {
                const el = document.getElementById('chart-history'); if (!el) return; if (historyChart) historyChart.dispose(); historyChart = echarts.init(el);
                const monthlyData = {}; for(let i=1; i<=12; i++) { const k = `${selectedYear.value}-${i < 10 ? '0'+i : i}`; monthlyData[k] = { inc: 0, exp: 0 }; }
                transactions.value.forEach(t => { 
                    if (t.date.startsWith(selectedYear.value + '-')) { 
                        const k = t.date.slice(0, 7); 
                        if (t.type === 'income') monthlyData[k].inc += Number(t.amount);
                        else if (t.category !== 'ÊäïËµÑ') monthlyData[k].exp += Number(t.amount);
                    } 
                });
                const monthsLabel = Array.from({length:12}, (_, i) => (i+1) + 'Êúà'); 
                const rates = Object.keys(monthlyData).sort().map(m => { const d = monthlyData[m]; return d.inc > 0 ? ((d.inc - d.exp)/d.inc * 100).toFixed(1) : 0; });
                const isDarkTheme = document.documentElement.classList.contains('dark'); const axisColor = isDarkTheme ? '#333' : '#e5e7eb'; const textColor = isDarkTheme ? '#666' : '#9ca3af';
                historyChart.setOption({ 
                    backgroundColor: 'transparent', tooltip: { trigger: 'axis', formatter: '{b}<br/>ÂÇ®ËìÑÁéá: [{c}%]' }, 
                    grid: { top: 20, right: 10, bottom: 20, left: 30 }, 
                    xAxis: { type: 'category', data: monthsLabel, axisLine: { lineStyle: { color: axisColor } }, axisLabel: { color: textColor, fontSize: 9 } }, 
                    yAxis: { type: 'value', splitLine: { show: false }, axisLabel: { color: textColor, fontSize: 9 } }, 
                    series: [{ type: 'line', data: rates, smooth: true, lineStyle: { width: 2, color: '#10b981' }, areaStyle: { opacity: 0.2, color: '#10b981' }, symbol: 'circle', label: { show: true, position: 'top', color: textColor, fontSize: 9, formatter: (p) => p.value ? `[${p.value}%]` : '' } }] 
                });
            }

            const updatePieChart = () => {
                const el = document.getElementById('chart-pie'); if (!el) return; if (pieChart) pieChart.dispose(); pieChart = echarts.init(el);
                const map = {}; 
                filteredTransactions.value.filter(t => t.type === 'expense' && t.category !== 'ÂÇ®ËìÑ' && t.category !== 'ÊäïËµÑ').forEach(t => map[t.category] = (map[t.category] || 0) + Number(t.amount));
                const isDarkTheme = document.documentElement.classList.contains('dark'); const labelColor = isDarkTheme ? '#888' : '#666'; const valueColor = isDarkTheme ? '#fff' : '#000';
                pieChart.setOption({ 
                    backgroundColor: 'transparent', tooltip: { trigger: 'item' }, 
                    series: [{ type: 'pie', radius: ['40%', '65%'], itemStyle: { borderRadius: 4, borderColor: isDarkTheme ? '#0a0a0a' : '#fff', borderWidth: 2 }, labelLine: { length: 10, length2: 0, lineStyle: { color: labelColor } }, label: { show: true, formatter: '{name|{b}}\n{value|¬•{c}} {rate|[{d}%]}', rich: { name: { color: labelColor, fontSize: 10 }, value: { color: valueColor, fontSize: 10 }, rate: { color: '#3b82f6', fontSize: 10, fontWeight: 'bold' } } }, data: Object.keys(map).map(k => ({ value: map[k], name: k })) }] 
                });
            }

            const updateStockTrendChart = () => {
                const el = document.getElementById('chart-stock-trend'); if (!el) return; if (stockTrendChart) stockTrendChart.dispose(); stockTrendChart = echarts.init(el);
                const monthlyProfit = {}; 
                for(let i=1; i<=12; i++) { const k = `${selectedYear.value}-${i < 10 ? '0'+i : i}`; monthlyProfit[k] = 0; }
                
                investmentTransactions.value.forEach(t => {
                    if (t.date.startsWith(selectedYear.value + '-')) {
                        const k = t.date.slice(0, 7);
                        if (t.category === 'ÁêÜË¥¢Êî∂Áõä') monthlyProfit[k] += Number(t.amount);
                        else if (t.category === 'ÁêÜË¥¢‰∫èÊçü') monthlyProfit[k] -= Number(t.amount);
                    }
                });
                
                const months = Array.from({length:12}, (_, i) => (i+1) + 'Êúà'); 
                const data = Object.keys(monthlyProfit).sort().map(k => ({ value: monthlyProfit[k] }));
                const isDarkTheme = document.documentElement.classList.contains('dark'); const axisColor = isDarkTheme ? '#333' : '#e5e7eb'; const textColor = isDarkTheme ? '#666' : '#9ca3af';
                
                stockTrendChart.setOption({
                    backgroundColor: 'transparent', tooltip: { trigger: 'axis', confine: true },
                    grid: { top: 20, right: 0, bottom: 20, left: 0 },
                    xAxis: { type: 'category', data: months, axisLine: { lineStyle: { color: axisColor } }, axisLabel: { color: textColor, fontSize: 9 } },
                    yAxis: { type: 'value', show: false },
                    series: [{ 
                        type: 'bar', data: data, barWidth: '40%', 
                        itemStyle: { color: (p) => p.value >= 0 ? '#10b981' : '#ef4444', borderRadius: [4, 4, 0, 0] }, 
                        label: { show: true, position: 'top', color: textColor, fontSize: 9, formatter: (p) => p.value != 0 ? `¬•${p.value}` : '' } 
                    }] 
                });
            }

            const updateStockAllocationChart = () => {
                const el = document.getElementById('chart-stock-allocation'); if (!el) return; if (stockAllocChart) stockAllocChart.dispose(); stockAllocChart = echarts.init(el);
                const data = currentHoldings.value.map(h => ({ value: h.cost, name: h.name }));
                const isDarkTheme = document.documentElement.classList.contains('dark'); const labelColor = isDarkTheme ? '#888' : '#666';
                stockAllocChart.setOption({
                    backgroundColor: 'transparent', tooltip: { trigger: 'item', formatter: '{b}<br/>Cost: ¬•{c}<br/>[{d}%]' },
                    series: [{
                        type: 'pie', radius: ['35%', '65%'], center: ['50%', '50%'],
                        itemStyle: { borderRadius: 4, borderColor: isDarkTheme ? '#0a0a0a' : '#fff', borderWidth: 2 },
                        label: { 
                            show: true, 
                            position: 'outside', 
                            formatter: '{b}\n{c} ({d}%)', 
                            fontSize: 10,
                            color: labelColor
                        },
                        labelLine: { show: true, length: 10, length2: 5 },
                        data: data.length ? data : [{value: 0, name: 'Empty'}]
                    }]
                });
            }

            const updateAllCharts = () => { 
                if(currentView.value === 'cashflow') { updateDailyChart(); updateHistoryChart(); updatePieChart(); } 
                else { updateStockTrendChart(); updateStockAllocationChart(); }
            }
            
            const fetchTransactions = async () => {
                const { data } = await _supabase.from('transactions').select('*').order('created_at', { ascending: true })
                if (data) { transactions.value = data; nextTick(() => updateAllCharts()); }
            }
            watch([selectedYear, selectedMonth, isDark], () => { setTimeout(updateAllCharts, 100); })

            const setMonth = (m) => { selectedMonth.value = m; showMonthPicker.value = false; }
            const openAddModal = () => { form.amount = ''; form.title = ''; form.category = currentCategories.value[0]; showModal.value = true; }
            const openAssetModal = () => { resetAssetForm(); assetForm.action = 'buy'; showAssetModal.value = true; }
            const selectHoldingItem = (h) => { selectedHolding.value = h; showHoldingPicker.value = false; }
            const resetAssetForm = () => { assetForm.amount = ''; assetForm.name = ''; assetForm.code = ''; selectedHolding.value = null; showHoldingPicker.value = false; }

            const saveTransaction = async () => {
                if (!form.amount || !form.title) return alert('Incomplete');
                const dStr = `${formYear.value}-${formMonth.value<10?'0'+formMonth.value:formMonth.value}-${formDay.value<10?'0'+formDay.value:formDay.value}`;
                const { error } = await _supabase.from('transactions').insert({ user_id: (await _supabase.auth.getUser()).data.user.id, title: form.title, amount: form.amount, type: form.type, category: form.category, date: dStr });
                if (!error) { showModal.value = false; fetchTransactions(); }
            }

            const saveAssetTransaction = async () => {
                const d = new Date();
                const dStr = `${d.getFullYear()}-${d.getMonth()+1<10?'0'+(d.getMonth()+1):d.getMonth()+1}-${d.getDate()<10?'0'+d.getDate():d.getDate()}`;
                const user_id = (await _supabase.auth.getUser()).data.user.id;
                
                if (assetForm.action === 'buy') {
                    if (!assetForm.amount || !assetForm.name) return alert('Fill info');
                    const codeStr = assetForm.code ? `(${assetForm.code})` : '';
                    await _supabase.from('transactions').insert({ user_id, title: `Buy: ${assetForm.name} ${codeStr}`, amount: assetForm.amount, type: 'expense', category: 'ÊäïËµÑ', date: dStr });
                } else {
                    if (!selectedHolding.value || !assetForm.amount) return alert('Select holding & amount');
                    const hold = selectedHolding.value;
                    const sellAmt = Number(assetForm.amount);
                    const cost = hold.cost;
                    const diff = sellAmt - cost;

                    const principalReturned = Math.min(sellAmt, cost); 
                    await _supabase.from('transactions').insert({ user_id, title: `Principal: ${hold.name}`, amount: principalReturned, type: 'income', category: 'ÊäïËµÑ', date: dStr });

                    if (diff > 0) {
                        await _supabase.from('transactions').insert({ user_id, title: `Sell: ${hold.name}`, amount: diff, type: 'income', category: 'ÁêÜË¥¢Êî∂Áõä', date: dStr });
                    } else if (diff < 0) {
                        await _supabase.from('transactions').insert({ user_id, title: `Loss: ${hold.name}`, amount: Math.abs(diff), type: 'expense', category: 'ÁêÜË¥¢‰∫èÊçü', date: dStr });
                    }
                }
                
                showAssetModal.value = false; fetchTransactions();
            }

            const deleteTransaction = async (id) => { if(confirm('Delete?')) { await _supabase.from('transactions').delete().eq('id', id); fetchTransactions(); } }

            onMounted(async () => {
                const { data: { session } } = await _supabase.auth.getSession();
                if(session) {
                    window.addEventListener('resize', () => { 
                        if(dailyChart) dailyChart.resize(); if(historyChart) historyChart.resize(); if(pieChart) pieChart.resize(); if(stockTrendChart) stockTrendChart.resize(); if(stockAllocChart) stockAllocChart.resize();
                    });
                    fetchTransactions();
                }
            })

            return { mobileMenuOpen, privacyMode, togglePrivacy, lifetimeStats, currentMonthStats, savingsRate, filteredTransactions, reversedFilteredTransactions, visibleInvestmentLogs, investmentStats, showModal, showAssetModal, showMonthPicker, showHoldingPicker, form, assetForm, currentCategories, selectedYear, selectedMonth, formYear, formMonth, formDay, daysInFormMonth, setMonth, openAddModal, openAssetModal, saveTransaction, saveAssetTransaction, deleteTransaction, nFormatter, formatDateTime, isDark, toggleTheme, currentView, switchView, currentHoldings, sortedHoldings, selectedHolding, selectHoldingItem, resetAssetForm, topHoldings, safeTitle }
        }
    }).mount('#app')
</script>
</body>
</html>


