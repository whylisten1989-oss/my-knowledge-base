<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindForge Bio-OS (V7.5 - Metabolism)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/global.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 'bg-dark': '#000000', 'bg-light': '#f8fafc' },
                    fontFamily: { sans: ['"JetBrains Mono"', '"Microsoft YaHei"', 'sans-serif'] },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glitch': 'glitch 0.2s linear infinite',
                        'flash-red': 'flashRed 0.5s ease-in-out',
                        'flash-green': 'flashGreen 0.5s ease-in-out',
                    },
                    keyframes: {
                        glitch: {
                            '0%': { transform: 'translate(2px,0) skew(0deg)' },
                            '20%': { transform: 'translate(-2px,0) skew(0deg)' },
                            '40%': { transform: 'translate(0,0) skew(5deg)' },
                            '60%': { transform: 'translate(2px,0) skew(0deg)' },
                            '80%': { transform: 'translate(-2px,0) skew(0deg)' },
                            '100%': { transform: 'translate(0,0) skew(0deg)' },
                        },
                        flashRed: {
                            '0%, 100%': { backgroundColor: 'transparent' },
                            '50%': { backgroundColor: 'rgba(239, 68, 68, 0.3)' }
                        },
                        flashGreen: {
                            '0%, 100%': { backgroundColor: 'transparent' },
                            '50%': { backgroundColor: 'rgba(16, 185, 129, 0.2)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] { display: none; }
        
        /* ËøõÂ∫¶Êù°Ê†∑Âºè */
        .progress-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Áä∂ÊÄÅÁâπÊïà */
        .critical-warning {
            border: 1px solid #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
            animation: pulse-slow 2s infinite;
        }
        
        /* ÈîÅÂÆöÈÅÆÁΩ© */
        .system-lock {
            position: relative;
            pointer-events: none;
            filter: grayscale(100%) contrast(1.2);
            opacity: 0.6;
        }
        .system-lock::after {
            content: "INSUFFICIENT ENERGY";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #000; color: #ef4444; border: 1px solid #ef4444;
            padding: 4px 8px; font-size: 10px; font-weight: bold; letter-spacing: 2px;
            z-index: 10;
        }

        .habit-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        .habit-card:hover { border-color: rgba(59, 130, 246, 0.3); }
    </style>
</head>
<body :class="['bg-bg-light dark:bg-bg-dark h-screen flex overflow-hidden transition-colors duration-500 text-gray-900 dark:text-gray-200 text-sm relative', screenEffect]">

<script src="js/config.js"></script>

<!-- ÂÖ®Â±èË≠¶ÂëäÁâπÊïàÂ±Ç -->
<div v-if="screenEffect" class="fixed inset-0 pointer-events-none z-[100] mix-blend-overlay"></div>

<div id="app" v-cloak class="h-full w-full flex relative z-10 flex-col md:flex-row">

    <!-- ‰æßËæπÊ†è -->
    <aside :class="['floating-sidebar w-64 flex flex-col justify-between transition-transform duration-300 fixed md:relative z-50 h-full bg-bg-light dark:bg-bg-dark border-r border-gray-200 dark:border-white/5', mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0']">
        <div>
            <div class="h-16 md:h-20 flex items-center px-6 md:px-8 border-b border-gray-200 dark:border-white/5">
                <span class="text-lg md:text-xl font-black tracking-tighter text-black dark:text-white cyber-logo">MindForge <span class="text-[10px] opacity-60 ml-1 font-normal">BIO-OS</span></span>
            </div>
            <nav class="p-4 space-y-2">
                <a href="index.html" class="nav-item w-full text-left block p-3 mb-1 text-xs">System Home</a>
                <a href="finance.html" class="nav-item w-full text-left block p-3 text-xs">Finance ÈáëËûç</a>
                <button class="nav-item w-full text-left block p-3 text-xs active">Habits ‰π†ÊÉØ</button>
            </nav>
        </div>
        <button @click="mobileMenuOpen = false" class="md:hidden absolute top-4 right-4 text-gray-400 p-2">‚úï</button>
    </aside>

    <main class="flex-1 flex flex-col bg-transparent relative w-full px-2 md:pl-4 md:pt-4 no-scroll-x h-full">
        
        <!-- Top HUD: ÁîüÁêÜÊåáÊ†áÁõëÊéß -->
        <header class="h-auto md:h-32 flex flex-col justify-between px-4 md:px-8 py-4 shrink-0 mb-4 cyber-card z-[40] bg-white/90 dark:bg-[#0a0a0a]/90 backdrop-blur-xl border border-gray-200 dark:border-white/10 shadow-lg">
            
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden text-xl">‚ò∞</button>
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Bio-Metric Status</span>
                </div>
                <!-- Ëá™Âä®Ë°∞ÂáèÊåáÁ§∫Âô® -->
                <div class="text-[9px] font-mono text-gray-500 animate-pulse">METABOLISM ACTIVE: -5% ENERGY/HR</div>
            </div>

            <!-- ÂèåËøõÂ∫¶Êù°Á≥ªÁªü -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <!-- 1. Neural Buffer (Á≤æÂäõ) -->
                <div>
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-[10px] font-bold text-blue-500 uppercase">Neural Buffer [Á≤æÂäõÁîµÂéã]</span>
                        <span :class="['text-xs font-mono font-bold', bufferColor]">{{ neuralBuffer.toFixed(1) }}%</span>
                    </div>
                    <div class="h-2 w-full bg-gray-200 dark:bg-white/10 rounded-full overflow-hidden relative">
                        <div :class="['h-full progress-bar', bufferColorBg]" :style="{width: neuralBuffer + '%'}"></div>
                        <!-- ‰ΩéËÉΩÈáèÈòàÂÄºÁ∫ø -->
                        <div class="absolute top-0 bottom-0 w-0.5 bg-red-500/50" style="left: 30%" title="Critical Threshold"></div>
                    </div>
                </div>

                <!-- 2. Health Integrity (ÂÅ•Â∫∑) -->
                <div>
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-[10px] font-bold text-green-500 uppercase">Health Integrity [Êú∫‰ΩìÂÅ•Â∫∑]</span>
                        <span :class="['text-xs font-mono font-bold', healthColor]">{{ healthIntegrity.toFixed(1) }}%</span>
                    </div>
                    <div class="h-2 w-full bg-gray-200 dark:bg-white/10 rounded-full overflow-hidden">
                        <div :class="['h-full progress-bar', healthColorBg]" :style="{width: healthIntegrity + '%'}"></div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto pr-2 md:pr-4 pb-4 relative z-10 custom-scroll space-y-6">
            
            <!-- SECTION 1: INTAKE & MAINTENANCE (ËæìÂÖ•/Áª¥Êä§) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- ÂñùÊ∞¥ -->
                <div class="cyber-card p-5 flex flex-col justify-between h-44 group relative overflow-hidden">
                    <div class="absolute bottom-0 left-0 w-full bg-blue-500/10 transition-all duration-700" :style="{height: (todayStats.water / 8 * 100) + '%'}"></div>
                    <div class="relative z-10 flex justify-between items-start">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Hydration</span>
                        <span class="text-xl">üíß</span>
                    </div>
                    <div class="relative z-10 text-3xl font-black">{{ todayStats.water }} <span class="text-xs font-normal text-gray-500">/ 8</span></div>
                    <button @click="drinkWater" class="relative z-10 w-full py-2 rounded border border-blue-500/30 text-blue-500 hover:bg-blue-500 hover:text-white text-xs font-bold transition">+ Hydrate (+2% Energy)</button>
                </div>

                <!-- ÂêÉÈ•≠ (Fuel) - NEW -->
                <div class="cyber-card p-5 flex flex-col justify-between h-44">
                    <div class="flex justify-between items-start">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Bio-Fuel Intake</span>
                        <span class="text-xl">üç±</span>
                    </div>
                    <div class="flex-1 flex flex-col justify-center gap-2">
                        <input v-model="inputs.food" type="text" placeholder="What did you eat?" class="cyber-input text-xs">
                        <button @click="eatFood" class="btn-cyber w-full py-2 rounded bg-orange-500/10 text-orange-500 border-orange-500/30 text-xs font-bold hover:bg-orange-500 hover:text-white">Confirm Fuel (+10% Energy)</button>
                    </div>
                </div>

                <!-- Áù°Áú† (Recharge) - NEW -->
                <div class="cyber-card p-5 flex flex-col justify-between h-44">
                    <div class="flex justify-between items-start">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Recharge Protocol</span>
                        <span class="text-xl">üåô</span>
                    </div>
                    <div class="flex-1 flex flex-col justify-center gap-2">
                        <div class="flex items-center gap-2">
                            <input v-model="inputs.sleep" type="number" placeholder="Hrs" class="cyber-input text-center w-16 text-lg font-bold">
                            <span class="text-xs text-gray-500">Hours Rest</span>
                        </div>
                        <button @click="sleep" class="btn-cyber w-full py-2 rounded bg-purple-500/10 text-purple-500 border-purple-500/30 text-xs font-bold hover:bg-purple-500 hover:text-white">Deep Sleep (Recover)</button>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: SYSTEM FIREWALL (ÊàíÈô§Á≥ªÁªü - Ê†∏ÂøÉÈÄªËæë) -->
            <div :class="['cyber-card p-6 border-l-4 transition-all duration-500 relative overflow-hidden', abstinenceStreak > 0 ? 'border-l-green-500' : 'border-l-red-500 system-failure']">
                <!-- Ë≠¶ÂëäÂä®ÁîªÂ±Ç -->
                <div v-if="nicotineCrashPending" class="absolute top-2 right-2 text-[9px] text-red-500 font-mono animate-pulse border border-red-500 px-2 py-1 rounded">
                    ‚ö† CRASH PENDING (-2h)
                </div>

                <div class="flex justify-between items-start mb-4 relative z-10">
                    <div>
                        <h3 class="text-xs font-bold text-black dark:text-white uppercase tracking-widest mb-1">
                            System Firewall [ÊàíÈô§ÁõëÊµã]
                        </h3>
                        <p class="text-[10px] text-gray-500">Protocol: No Smoking / No Late Night</p>
                    </div>
                    <div class="text-right">
                        <div :class="['text-3xl font-black font-mono', abstinenceStreak > 0 ? 'text-green-500' : 'text-red-500']">
                            {{ abstinenceStreak }} <span class="text-xs text-gray-500 font-normal">DAYS SECURE</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 relative z-10">
                    <!-- Âê∏ÁÉüÊåâÈíÆÔºöÂ∏¶‰∏•ÈáçË≠¶ÂëäÈÄªËæë -->
                    <button @click="triggerNicotine" class="px-4 py-2 rounded border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white text-[10px] font-bold uppercase tracking-widest transition flex items-center gap-2">
                        <span>üö¨ INJECT TOXIN (Short Boost / Long Crash)</span>
                    </button>
                </div>
            </div>

            <!-- SECTION 3: SKILL UPLOAD (ÂèóÁ≤æÂäõÂÄºÈîÅÂÆöÁöÑ‰ªªÂä°) -->
            <div class="cyber-card p-6 relative">
                <!-- ‰ΩéËÉΩÈáèÈîÅÂÆöÈÅÆÁΩ© -->
                <div v-if="neuralBuffer < 30" class="absolute inset-0 bg-black/50 z-20 backdrop-blur-[2px] flex items-center justify-center border border-red-500/30 rounded-xl">
                    <div class="text-center">
                        <div class="text-4xl mb-2">üîã</div>
                        <h3 class="text-red-500 font-black tracking-widest text-lg animate-pulse">SYSTEM DEPLETED</h3>
                        <p class="text-xs text-gray-300 mt-1">Recharge required to execute high-level protocols.</p>
                    </div>
                </div>

                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4 border-b border-gray-200 dark:border-white/10 pb-2 flex justify-between">
                    <span>Skill Upload [ËÉΩÂäõËøõÂåñ]</span>
                    <span class="text-blue-500 font-mono">{{ neuralBuffer >= 30 ? 'SYSTEM READY' : 'OFFLINE' }}</span>
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Piano -->
                    <div class="space-y-2">
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Piano Session (Mins)</label>
                        <div class="flex gap-2">
                            <input v-model="inputs.piano" type="number" placeholder="0" class="cyber-input text-center font-mono">
                            <button @click="addHabit('piano', inputs.piano)" class="btn-cyber px-4 rounded bg-white dark:bg-white text-black text-xs font-bold hover:opacity-80">LOG</button>
                        </div>
                    </div>

                    <!-- Study -->
                    <div class="space-y-2">
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Deep Study (Mins)</label>
                        <div class="flex gap-2">
                            <input v-model="inputs.study" type="number" placeholder="0" class="cyber-input text-center font-mono">
                            <button @click="addHabit('study', inputs.study)" class="btn-cyber px-4 rounded bg-white dark:bg-white text-black text-xs font-bold hover:opacity-80">LOG</button>
                        </div>
                    </div>

                    <!-- Sport -->
                    <div class="space-y-2">
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Kinetic Sport (Mins)</label>
                        <div class="flex gap-2">
                            <input v-model="inputs.sport" type="number" placeholder="0" class="cyber-input text-center font-mono">
                            <button @click="addHabit('sport', inputs.sport)" class="btn-cyber px-4 rounded bg-white dark:bg-white text-black text-xs font-bold hover:opacity-80">LOG</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 4: NEURAL STREAM -->
            <div class="cyber-card flex flex-col h-60">
                <div class="p-4 border-b border-gray-200 dark:border-white/5 bg-gray-50 dark:bg-white/5 flex justify-between items-center">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Metabolic Log</h3>
                    <span class="text-[10px] font-mono text-blue-500">LIVE SYNC</span>
                </div>
                <div class="flex-1 overflow-y-auto p-4 custom-scroll space-y-2">
                    <div v-if="logs.length === 0" class="text-center text-xs text-gray-500 py-4">No activity recorded today.</div>
                    <div v-for="log in logs" :key="log.id" class="flex justify-between items-center text-xs font-mono border-b border-gray-200 dark:border-white/5 pb-1 last:border-0">
                        <span class="text-blue-500">[{{ formatTime(log.created_at) }}]</span>
                        <span class="text-black dark:text-white uppercase truncate max-w-[150px]">{{ log.habit_name.replace(/_/g, ' ') }}</span>
                        <!-- ÊòæÁ§∫ÂÖ∑‰ΩìÁöÑÊï∞ÂÄºÂèòÂåñ (Â¶ÇÊûúÊòØÂ§áÊ≥®‰ø°ÊÅØÂàôÊòæÁ§∫ÊñáÊú¨) -->
                        <span class="font-bold text-green-500">{{ isNaN(log.value) ? 'NOTE' : '+' + log.value }}</span>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
    const { createApp, ref, onMounted, reactive, computed, watch } = Vue

    createApp({
        setup() {
            let _supabase = null;
            if (window._supabase) _supabase = window._supabase;

            const isDark = ref(true)
            const mobileMenuOpen = ref(false)
            
            // 1. Life Clock
            const birthYear = 1995; 
            const lifeExpectancy = 80;
            const lifeProgress = computed(() => {
                const now = new Date();
                const age = now.getFullYear() - birthYear;
                return ((age / lifeExpectancy) * 100).toFixed(1);
            });

            // 2. Bio-Engine State (ÁîüÁêÜÂºïÊìéÊ†∏ÂøÉÁä∂ÊÄÅ)
            const neuralBuffer = ref(80); // Á≤æÂäõ (0-100)
            const healthIntegrity = ref(90); // ÂÅ•Â∫∑ (0-100)
            const screenEffect = ref(''); // Â±èÂπïÁâπÊïà class
            const nicotineCrashPending = ref(false); // ÊòØÂê¶ÊúâÂç≥Â∞ÜÂà∞Êù•ÁöÑÂ∞ºÂè§‰∏ÅÂ¥©Ê∫É

            // Ëá™Âä®Ë°∞ÂáèÈÄªËæë (Ê®°Êãü‰ª£Ë∞¢)
            const decayTicker = () => {
                // ÊØèÂàÜÈíüË°∞ÂáèÂ§ßÁ∫¶ 0.08% (ÊØèÂ∞èÊó∂Á∫¶ 5%)
                if (neuralBuffer.value > 0) neuralBuffer.value = Math.max(0, neuralBuffer.value - 0.08);
                // ÂÅ•Â∫∑ÂÄºËá™ÁÑ∂Ë°∞ÂáèÊûÅÊÖ¢ÔºåÂøΩÁï•‰∏çËÆ°Ôºå‰∏ªË¶ÅÂèó‰∫ã‰ª∂ÂΩ±Âìç
            };

            const bufferColor = computed(() => neuralBuffer.value < 30 ? 'text-red-500' : (neuralBuffer.value > 70 ? 'text-green-500' : 'text-yellow-500'));
            const bufferColorBg = computed(() => neuralBuffer.value < 30 ? 'bg-red-500' : (neuralBuffer.value > 70 ? 'bg-green-500' : 'bg-yellow-500'));
            const bufferStatus = computed(() => {
                if (neuralBuffer.value >= 70) return { text: 'OPTIMAL', color: 'text-green-500' };
                if (neuralBuffer.value >= 30) return { text: 'NOMINAL', color: 'text-yellow-500' };
                return { text: 'CRITICAL (LOCKED)', color: 'text-red-500' };
            });

            const healthColor = computed(() => healthIntegrity.value < 50 ? 'text-red-500' : 'text-green-500');
            const healthColorBg = computed(() => healthIntegrity.value < 50 ? 'bg-red-500' : 'bg-green-500');

            // 3. Habits Logic
            const logs = ref([]);
            const inputs = reactive({ piano: '', study: '', sport: '', food: '', sleep: '' });
            
            const todayStats = computed(() => {
                const stats = { water: 0, teeth_am: 0, teeth_pm: 0, face: 0, house: 0 };
                logs.value.forEach(log => {
                    if (stats[log.habit_name] !== undefined) stats[log.habit_name] += Number(log.value);
                });
                return stats;
            });

            const lastBreachDate = ref(null); 
            const abstinenceStreak = computed(() => {
                if (!lastBreachDate.value) return 12; 
                const today = new Date();
                const last = new Date(lastBreachDate.value);
                const diffTime = Math.abs(today - last);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            });

            // Actions
            const fetchLogs = async () => {
                if (!_supabase) return;
                const today = new Date().toISOString().split('T')[0];
                const { data } = await _supabase.from('habit_logs').select('*').eq('date', today).order('created_at', { ascending: false });
                if (data) logs.value = data;
            };

            const logAction = async (name, value, note = '') => {
                if (!_supabase) return alert("Offline Mode");
                
                // ËÆ∞ÂΩïÂà∞Êï∞ÊçÆÂ∫ì
                const { error } = await _supabase.from('habit_logs').insert({
                    user_id: (await _supabase.auth.getUser()).data.user.id,
                    habit_name: name,
                    value: value,
                    date: new Date().toISOString().split('T')[0]
                });
                if (!error) {
                    fetchLogs();
                    // ËøôÈáåÂèØ‰ª•Âä†ÂÖ•‰øùÂ≠ò buffer/health Áä∂ÊÄÅÂà∞Êï∞ÊçÆÂ∫ìÁöÑÈÄªËæë (Â¶ÇÊûúÈúÄË¶ÅË∑®ËÆæÂ§áÂêåÊ≠•Áä∂ÊÄÅ)
                }
            };

            // --- Ê†∏ÂøÉÁîüÁêÜ‰∫§‰∫í ---

            // 1. ÂñùÊ∞¥: ÊÅ¢Â§çÁ≤æÂäõ‰∏éÂÅ•Â∫∑
            const drinkWater = async () => {
                neuralBuffer.value = Math.min(100, neuralBuffer.value + 3);
                healthIntegrity.value = Math.min(100, healthIntegrity.value + 1);
                screenEffect.value = 'animate-flash-green';
                setTimeout(() => screenEffect.value = '', 500);
                await logAction('water', 1);
            };

            // 2. ÂêÉÈ•≠: Ë°•ÂÖÖËÉΩÈáè
            const eatFood = async () => {
                if (!inputs.food) return alert("Please specify food.");
                neuralBuffer.value = Math.min(100, neuralBuffer.value + 10);
                healthIntegrity.value = Math.min(100, healthIntegrity.value + 2);
                await logAction('food', 1, inputs.food); // ËøôÈáåÁÆÄÂåñ value ‰∏∫ 1ÔºåÂÆûÈôÖÂèØ‰ª•Â≠òÂ§áÊ≥®
                inputs.food = '';
            };

            // 3. Áù°Áú†: Âº∫ÂäõÊÅ¢Â§ç (ÈùûÁ∫øÊÄß)
            const sleep = async () => {
                if (!inputs.sleep) return;
                const hours = parseFloat(inputs.sleep);
                // ÊÅ¢Â§çÂÖ¨Âºè: Ââç4Â∞èÊó∂ÊØèÂ∞èÊó∂+5Ôºå‰πãÂêéÊØèÂ∞èÊó∂+10 (ÈºìÂä±Áù°Â§ü)
                let recovery = 0;
                if (hours <= 4) recovery = hours * 5;
                else recovery = (4 * 5) + ((hours - 4) * 10);
                
                neuralBuffer.value = Math.min(100, neuralBuffer.value + recovery);
                healthIntegrity.value = Math.min(100, healthIntegrity.value + (hours * 2));
                
                await logAction('sleep', hours);
                inputs.sleep = '';
            };

            // 4. Âê∏ÁÉü (Toxic Injection): Áü≠ÊúüÊèêÂçáÔºåÈïøÊúüÂ¥©Ê∫É
            const triggerNicotine = async () => {
                if(!confirm("‚ö†Ô∏è WARNING: TOXIN DETECTED.\nThis will spike energy briefly but cause a CRASH in 2 hours.\nHealth integrity will be damaged.\nProceed?")) return;

                // Áü≠ÊúüÊïàÊûú
                neuralBuffer.value = Math.min(100, neuralBuffer.value + 15); // Nicotine Spike
                healthIntegrity.value = Math.max(0, healthIntegrity.value - 5); // Lung Damage
                
                // ËßÜËßâÊÉ©ÁΩö
                screenEffect.value = 'animate-flash-red';
                setTimeout(() => screenEffect.value = '', 500);
                nicotineCrashPending.value = true;

                // ËÆ∞ÂΩïÁ†¥Êàí
                await logAction('debuff_smoke', 1);
                lastBreachDate.value = new Date();

                // Ê®°ÊãüÂª∂ËøüÂ¥©Ê∫É (‰∏∫‰∫ÜÊºîÁ§∫ÊïàÊûúÔºåËøôÈáåËÆæ‰∏∫ 5ÁßíÂêéÊ®°Êãü 2Â∞èÊó∂ÂêéÁöÑÊïàÊûúÔºåÂÆûÈôÖÂ∫îÁî®ÂèØÂ≠òÂÖ• localStorage ËÆ°ÁÆóÊó∂Èó¥Â∑Æ)
                setTimeout(() => {
                    alert("‚ö† SYSTEM CRASH: NICOTINE WITHDRAWAL\nEnergy -30%");
                    neuralBuffer.value = Math.max(0, neuralBuffer.value - 30);
                    nicotineCrashPending.value = false;
                }, 5000); 
            };

            // ÊôÆÈÄö‰π†ÊÉØËÆ∞ÂΩï
            const addHabit = async (name, val) => {
                if(neuralBuffer.value < 30) return; // ÂÜçÊ¨°Êã¶Êà™
                await logAction(name, val);
                inputs[name] = '';
            };

            const toggleToggleHabit = async (name) => {
                if (todayStats.value[name] >= 1) return; 
                await logAction(name, 1);
                // Â∞èÂπÖÂ•ñÂä±
                neuralBuffer.value = Math.min(100, neuralBuffer.value + 1);
            };

            const saveBufferLog = () => { /* Placeholder for manual slider adjust */ }

            const toggleTheme = () => { isDark.value = !isDark.value; if(isDark.value){document.documentElement.classList.add('dark');localStorage.setItem('theme','dark')}else{document.documentElement.classList.remove('dark');localStorage.setItem('theme','light')} }
            if (localStorage.getItem('theme') === 'light') { isDark.value = false; document.documentElement.classList.remove('dark'); }

            const formatTime = (iso) => new Date(iso).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            onMounted(() => {
                fetchLogs();
                // ÂêØÂä®‰ª£Ë∞¢Êó∂Èíü
                setInterval(decayTicker, 60000); // ÊØèÂàÜÈíüÊâßË°åË°∞Âáè
            });

            return { isDark, toggleTheme, mobileMenuOpen, lifeProgress, neuralBuffer, healthIntegrity, bufferStatus, bufferColor, bufferColorBg, healthColor, healthColorBg, todayStats, logs, inputs, addHabit, toggleToggleHabit, triggerNicotine, drinkWater, eatFood, sleep, abstinenceStreak, saveBufferLog, formatTime, screenEffect, nicotineCrashPending }
        }
    }).mount('#app')
</script>
</body>
</html>
