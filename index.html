<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Digital Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'void': '#09090b', 'surface': '#18181b', 'accent': '#fafafa', 
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #a1a1aa; }
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        .md-content h1, .md-content h2 { color: #fafafa; font-weight: 700; margin-bottom: 0.5rem; }
        .md-content p { margin-bottom: 0.8rem; line-height: 1.6; }
        .md-content a { color: #38bdf8; text-decoration: underline; }
        .md-content pre { background: #27272a; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

<div id="app" class="flex-1 flex flex-col relative">

    <nav class="sticky top-0 z-50 glass border-b border-white/5 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-black font-bold text-lg">K</div>
            <span class="font-semibold text-white tracking-tight">Knowledge_Base</span>
        </div>
        <div class="flex items-center gap-4 text-sm">
            <div v-if="user" class="flex items-center gap-3">
                <span v-if="isAdmin" class="text-green-500 flex items-center gap-1 bg-green-900/20 px-2 py-1 rounded">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ADMIN
                </span>
                <span v-else class="text-gray-500 border border-gray-700 px-2 py-1 rounded">VISITOR</span>
                <button v-if="isAdmin" @click="openEditor()" class="text-white hover:text-gray-300 transition font-bold">+ æ–°å»º</button>
                <button @click="handleLogout" class="text-gray-500 hover:text-white transition">é€€å‡º</button>
            </div>
            <button v-else @click="showAuthModal = true" class="px-4 py-2 border border-white/20 rounded-full hover:bg-white hover:text-black transition duration-300">
                ç™»å½• / æ³¨å†Œ
            </button>
        </div>
    </nav>

    <main class="flex-1 max-w-5xl mx-auto w-full p-6">
        <header class="py-20 text-center">
            <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tighter">
                Thinking in <span class="text-transparent bg-clip-text bg-gradient-to-r from-gray-200 to-gray-600">Public</span>.
            </h1>
            <p class="text-gray-400 max-w-xl mx-auto text-lg">
                {{ isAdmin ? 'æ¬¢è¿å›æ¥ï¼Œä¸»äººã€‚' : 'æ¬¢è¿å‚è§‚æˆ‘çš„æ•°å­—èŠ±å›­ã€‚' }}
            </p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div v-for="note in notes" :key="note.id" class="group relative bg-surface border border-white/5 rounded-2xl p-6 hover:border-white/20 transition duration-300 flex flex-col h-64">
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-white/10 text-gray-400 px-2 py-1 rounded text-xs font-mono uppercase">{{ note.type || 'note' }}</span>
                    <span v-if="!note.is_public && isAdmin" class="text-yellow-500 text-xs">ğŸ”’ ç§å¯†</span>
                </div>
                <h3 class="text-xl font-bold text-gray-100 mb-2 group-hover:text-white transition">{{ note.title }}</h3>
                <div class="flex-1 overflow-hidden text-sm text-gray-500 md-content relative">
                    <div v-html="renderMarkdown(note.content)"></div>
                    <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-surface to-transparent"></div>
                </div>
                <div v-if="isAdmin" class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                    <button @click="editNote(note)" class="p-2 bg-white text-black rounded-full hover:scale-110 transition shadow-lg">âœ</button>
                </div>
            </div>
        </div>
    </main>

    <div v-if="showAuthModal && !user" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass p-8 rounded-2xl w-full max-w-md relative animate-fade-in-up">
            <button @click="showAuthModal = false" class="absolute top-4 right-4 text-gray-500 hover:text-white">âœ•</button>
            <h2 class="text-2xl font-bold text-white mb-6 text-center">{{ isRegisterMode ? 'åŠ å…¥ç¤¾åŒº' : 'èº«ä»½éªŒè¯' }}</h2>
            <div class="space-y-4">
                <input v-model="email" type="email" placeholder="Email" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-white/50 outline-none">
                <input v-model="password" type="password" placeholder="Password" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-white/50 outline-none">
                <button @click="handleAuth" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition">
                    {{ isRegisterMode ? 'ç«‹å³æ³¨å†Œ' : 'ç™»å½• / Unlock' }}
                </button>
                <div class="text-center text-xs text-gray-500 mt-4 cursor-pointer hover:text-white" @click="isRegisterMode = !isRegisterMode">
                    {{ isRegisterMode ? 'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•' : 'æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ' }}
                </div>
            </div>
        </div>
    </div>

    <div v-if="showEditor && isAdmin" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="bg-surface w-full max-w-4xl h-[80vh] rounded-2xl border border-white/10 flex flex-col shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-void">
                <h3 class="text-white font-bold">{{ form.id ? 'ç¼–è¾‘' : 'æ–°å»º' }}</h3>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" v-model="form.is_public" class="w-4 h-4">
                        <span :class="form.is_public ? 'text-green-400' : 'text-gray-500'">{{ form.is_public ? 'ğŸŸ¢ å…¬å¼€' : 'ğŸ”’ ç§å¯†' }}</span>
                    </label>
                    <button @click="closeEditor" class="text-gray-400 hover:text-white">å–æ¶ˆ</button>
                    <button @click="saveNote" class="bg-white text-black px-6 py-1.5 rounded-full font-bold hover:bg-gray-200 transition">ä¿å­˜</button>
                </div>
            </div>
            <div class="flex-1 flex flex-col md:flex-row">
                <div class="flex-1 p-6 flex flex-col gap-4 border-r border-white/5">
                    <input v-model="form.title" placeholder="è¾“å…¥æ ‡é¢˜..." class="bg-transparent text-2xl font-bold text-white outline-none">
                    <textarea v-model="form.content" placeholder="æ”¯æŒ Markdown..." class="flex-1 bg-void/50 p-4 rounded-lg text-gray-300 font-mono outline-none resize-none border border-white/5 focus:border-white/20"></textarea>
                </div>
                <div class="flex-1 p-6 bg-black/20 overflow-y-auto">
                    <div class="md-content text-gray-300" v-html="renderMarkdown(form.content)"></div>
                </div>
            </div>
            <div v-if="form.id" class="p-4 bg-red-900/10 border-t border-red-900/20 flex justify-between items-center">
                <span class="text-xs text-red-400">å±é™©åŒºåŸŸ</span>
                <button @click="deleteNote" class="text-xs text-red-500 hover:text-red-300 underline">åˆ é™¤æ­¤æ¡ç›®</button>
            </div>
        </div>
    </div>

</div>

<script>
    // 0. è‡ªæ£€é€»è¾‘ï¼šé˜²æ­¢ Vue å’Œ Supabase æ²¡åŠ è½½å¯¼è‡´ç™½å±
    if (typeof Vue === 'undefined') alert('âŒ Vue åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼');
    if (typeof supabase === 'undefined') alert('âŒ Supabase åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼');

    const { createApp, ref, computed, onMounted, reactive } = Vue
    const { createClient } = supabase

    // ==========================================
    // ğŸ”´ å¿…å¡«åŒºï¼šè¯·åŠ¡å¿…ä¿ç•™å¼•å·ï¼ä¸è¦åˆ ï¼
    // ==========================================
    
    // 1. ä½ çš„é¡¹ç›®åœ°å€ (ä¿ç•™å•å¼•å·)
    const SUPABASE_URL = 'https://fjuxtlzbeeexyczfrqsq.supabase.co'
    
    // 2. ä½ çš„ Key (ä¿ç•™å•å¼•å·ï¼Œä¸è¦æœ‰ç©ºæ ¼)
    const SUPABASE_ANON_KEY = 'sb_publishable_1Q5sjgjl5Fmd4-nDlhrFWA_wWYgAUDu'

    // 3. ä½ çš„é‚®ç®± (ä¿ç•™å•å¼•å·)
    const ADMIN_EMAIL = '1493694948@qq.com' 

    // ==========================================
    // ğŸ›‘ å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœä½ å¿˜äº†å¡«ï¼Œæˆ‘ä¼šå¼¹çª—æé†’ä½ 
    // ==========================================
    if (SUPABASE_URL.includes('ä½ çš„é¡¹ç›®ID') || SUPABASE_ANON_KEY.includes('ä½ çš„é‚£ä¸€é•¿ä¸²')) {
        alert('ğŸ›‘ åœä¸€ä¸‹ï¼\n\nä½ å¿˜è®°åœ¨ä»£ç åº•éƒ¨å¡«å…¥ä½ è‡ªå·±çš„ Supabase URL å’Œ Key äº†ï¼\n\nè¯·ä¿®æ”¹ä»£ç æœ€ä¸‹æ–¹çš„é…ç½®ã€‚');
    }

    // åˆå§‹åŒ–å®¢æˆ·ç«¯
    let _supabase = null;
    try {
        _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    } catch (e) {
        alert('âŒ åˆå§‹åŒ–å¤±è´¥ï¼šè¯·æ£€æŸ¥ Key æ˜¯å¦å¡«å¯¹äº†ï¼Ÿ\né”™è¯¯ä¿¡æ¯ï¼š' + e.message)
    }

    createApp({
        setup() {
            const user = ref(null)
            const showAuthModal = ref(false)
            const showEditor = ref(false)
            const isRegisterMode = ref(false)
            const email = ref('')
            const password = ref('')
            const notes = ref([])
            const form = reactive({ id: null, title: '', content: '', is_public: false, type: 'note' })

            const isAdmin = computed(() => user.value && user.value.email === ADMIN_EMAIL)

            onMounted(async () => {
                if(!_supabase) return; // å¦‚æœåˆå§‹åŒ–æŒ‚äº†ï¼Œå°±ä¸è·‘äº†
                const { data: { session } } = await _supabase.auth.getSession()
                user.value = session?.user || null
                fetchNotes()
                _supabase.auth.onAuthStateChange((_, session) => {
                    user.value = session?.user || null
                    fetchNotes()
                })
            })

            const fetchNotes = async () => {
                const { data } = await _supabase.from('notes').select('*').order('created_at', { ascending: false })
                if (data) notes.value = data
            }

            const handleAuth = async () => {
                const action = isRegisterMode.value ? _supabase.auth.signUp : _supabase.auth.signInWithPassword
                const { error } = await action({ email: email.value, password: password.value })
                if (error) alert(error.message)
                else showAuthModal.value = false
            }

            const handleLogout = async () => { await _supabase.auth.signOut() }

            const openEditor = () => { Object.assign(form, { id: null, title: '', content: '', is_public: false, type: 'note' }); showEditor.value = true; }
            const editNote = (note) => { Object.assign(form, note); showEditor.value = true; }
            const closeEditor = () => showEditor.value = false

            const saveNote = async () => {
                if (!form.title) return alert('æ ‡é¢˜å¿…å¡«')
                const payload = { ...form, user_id: user.value.id }
                delete payload.id
                if (form.id) await _supabase.from('notes').update(payload).eq('id', form.id)
                else await _supabase.from('notes').insert(payload)
                showEditor.value = false; fetchNotes();
            }

            const deleteNote = async () => {
                if(confirm('åˆ é™¤?')) { await _supabase.from('notes').delete().eq('id', form.id); showEditor.value = false; fetchNotes(); }
            }

            const renderMarkdown = (text) => text ? marked.parse(text) : ''

            return {
                user, isAdmin, showAuthModal, showEditor, isRegisterMode, email, password, notes, form,
                handleAuth, handleLogout, openEditor, editNote, saveNote, deleteNote, renderMarkdown, closeEditor
            }
        }
    }).mount('#app')
</script>
</body>
</html>
