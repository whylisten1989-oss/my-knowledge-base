<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç§å¯†ç©ºé—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans text-gray-800">

<div id="app" class="w-full max-w-md p-6 bg-white rounded-xl shadow-lg border border-gray-200">
    
    <div class="mb-8 text-center">
        <h1 class="text-2xl font-bold text-gray-900">ğŸ”’ ä¸ªäººç§å¯†ç©ºé—´</h1>
        <p v-if="user" class="text-sm text-green-600 mt-2">å·²å®‰å…¨è¿æ¥: {{ user.email }}</p>
        <p v-else class="text-sm text-gray-500 mt-2">è¯·ç™»å½•ä»¥è®¿é—®åŠ å¯†æ•°æ®</p>
    </div>

    <div v-if="!user" class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">é‚®ç®±</label>
            <input v-model="email" type="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="your@email.com">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">å¯†ç </label>
            <input v-model="password" type="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="********">
        </div>
        <div class="flex gap-2">
            <button @click="handleLogin" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition">ç™»å½•</button>
            <button @click="handleSignUp" class="flex-1 bg-white text-indigo-600 border border-indigo-600 py-2 px-4 rounded-md hover:bg-gray-50 transition">æ³¨å†Œ</button>
        </div>
        <p class="text-xs text-center text-gray-400">é¦–æ¬¡ä½¿ç”¨è¯·ç‚¹å‡»â€œæ³¨å†Œâ€<br>æ•°æ®å°†é€šè¿‡ HTTPS åŠ å¯†ä¼ è¾“</p>
    </div>

    <div v-else>
        <div class="flex gap-2 mb-6">
            <input v-model="newTask" @keyup.enter="addTask" type="text" placeholder="è®°å½•ä¸€ä¸ªæ–°çš„æƒ³æ³•..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            <button @click="addTask" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">+</button>
        </div>

        <div class="space-y-2 max-h-96 overflow-y-auto">
            <div v-for="todo in todos" :key="todo.id" class="flex items-center justify-between p-3 bg-gray-50 rounded-lg group hover:bg-gray-100 transition">
                <div class="flex items-center gap-3">
                    <input type="checkbox" :checked="todo.is_complete" @change="toggleTodo(todo)" class="h-4 w-4 text-indigo-600 rounded border-gray-300">
                    <span :class="{'line-through text-gray-400': todo.is_complete}">{{ todo.task }}</span>
                </div>
                <button @click="deleteTodo(todo.id)" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition text-sm">åˆ é™¤</button>
            </div>
            <p v-if="todos.length === 0" class="text-center text-gray-400 py-4">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¼€å§‹è®°å½•å§</p>
        </div>

        <button @click="handleLogout" class="mt-8 w-full text-sm text-gray-500 hover:text-gray-800 underline">é€€å‡ºå®‰å…¨è¿æ¥</button>
    </div>

</div>

<script>
    const { createApp, ref, onMounted } = Vue
    const { createClient } = supabase

    // ==========================================
    // ğŸ”´ è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Supabase é…ç½® !!!
    // ==========================================
    const SUPABASE_URL = 'https://fjuxtlzbeeexyczfrqsq.supabase.co'
    const SUPABASE_ANON_KEY = 'sb_publishable_1Q5sjgjl5Fmd4-nDlhrFWA_wWYgAUDu'

    const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    createApp({
        setup() {
            const user = ref(null)
            const email = ref('')
            const password = ref('')
            const todos = ref([])
            const newTask = ref('')

            // 1. æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç™»å½•
            onMounted(async () => {
                const { data: { session } } = await _supabase.auth.getSession()
                if (session) {
                    user.value = session.user
                    fetchTodos()
                }

                // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
                _supabase.auth.onAuthStateChange((_event, session) => {
                    user.value = session?.user || null
                    if (user.value) fetchTodos()
                    else todos.value = []
                })
            })

            // 2. æ³¨å†Œ
            const handleSignUp = async () => {
                const { error } = await _supabase.auth.signUp({ email: email.value, password: password.value })
                if (error) alert(error.message)
                else alert('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥ä½ çš„é‚®ç®±ç¡®è®¤é“¾æ¥ï¼ˆå¦‚æœæ˜¯çœŸé‚®ç®±çš„è¯ï¼‰ï¼Œæˆ–è€…å» Supabase åå°å…³é—­â€œé‚®ç®±éªŒè¯â€é€‰é¡¹ç›´æ¥ç™»å½•ã€‚')
            }

            // 3. ç™»å½•
            const handleLogin = async () => {
                const { error } = await _supabase.auth.signInWithPassword({ email: email.value, password: password.value })
                if (error) alert(error.message)
            }

            // 4. ç™»å‡º
            const handleLogout = async () => {
                await _supabase.auth.signOut()
            }

            // 5. è·å–æ•°æ® (Read)
            const fetchTodos = async () => {
                const { data, error } = await _supabase
                    .from('todos')
                    .select('*')
                    .order('created_at', { ascending: false })
                if (error) console.error(error)
                else todos.value = data
            }

            // 6. æ·»åŠ æ•°æ® (Create)
            const addTask = async () => {
                if (!newTask.value.trim()) return
                const { error } = await _supabase
                    .from('todos')
                    .insert({ task: newTask.value, user_id: user.value.id })
                
                if (error) console.error(error)
                else {
                    newTask.value = ''
                    fetchTodos()
                }
            }

            // 7. æ›´æ–°çŠ¶æ€ (Update)
            const toggleTodo = async (todo) => {
                const { error } = await _supabase
                    .from('todos')
                    .update({ is_complete: !todo.is_complete })
                    .eq('id', todo.id)
                if (error) console.error(error)
                else fetchTodos() // åˆ·æ–°ä¸€ä¸‹
            }

            // 8. åˆ é™¤æ•°æ® (Delete)
            const deleteTodo = async (id) => {
                const { error } = await _supabase.from('todos').delete().eq('id', id)
                if (error) console.error(error)
                else fetchTodos()
            }

            return {
                user, email, password, todos, newTask,
                handleLogin, handleSignUp, handleLogout, addTask, toggleTodo, deleteTodo
            }
        }
    }).mount('#app')
</script>
</body>

</html>
