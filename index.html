<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Digital Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // å®šä¹‰ä¸€ç§é«˜çº§çš„â€œé»‘â€ï¼Œä¸æ˜¯çº¯é»‘ï¼Œæ˜¯å¸¦ä¸€ç‚¹ç‚¹è“çš„æ·±ç°ï¼Œä¹…çœ‹ä¸ç´¯
                        'void': '#09090b', 
                        'surface': '#18181b',
                        'accent': '#fafafa', // æäº®ç™½ä½œä¸ºå¼ºè°ƒ
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* å¼•å…¥é«˜çº§å­—ä½“ Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #a1a1aa; }
        
        /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœ (ç”¨äºç™»å½•æ¡†) */
        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* éšå½¢æ»šåŠ¨æ¡ï¼Œä¿æŒç•Œé¢ç®€æ´ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        
        /* æç®€ Markdown æ ·å¼é‡å†™ */
        .md-content h1, .md-content h2 { color: #fafafa; font-weight: 700; margin-bottom: 0.5rem; }
        .md-content p { margin-bottom: 0.8rem; line-height: 1.6; }
        .md-content a { color: #38bdf8; text-decoration: underline; }
        .md-content pre { background: #27272a; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

<div id="app" class="flex-1 flex flex-col relative">

    <nav class="sticky top-0 z-50 glass border-b border-white/5 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-black font-bold text-lg">K</div>
            <span class="font-semibold text-white tracking-tight">Knowledge_Base</span>
        </div>

        <div class="flex items-center gap-4 text-sm">
            <div v-if="user" class="flex items-center gap-3">
                <span class="text-green-500 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    Owner
                </span>
                <button @click="showEditor = true" class="text-white hover:text-gray-300 transition">+ æ–°å»º</button>
                <button @click="handleLogout" class="text-gray-500 hover:text-white transition">é€€å‡º</button>
            </div>
            <button v-else @click="showLogin = true" class="px-4 py-2 border border-white/20 rounded-full hover:bg-white hover:text-black transition duration-300">
                Login
            </button>
        </div>
    </nav>

    <main class="flex-1 max-w-5xl mx-auto w-full p-6">
        
        <header class="py-20 text-center">
            <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tighter">
                Thinking in <span class="text-transparent bg-clip-text bg-gradient-to-r from-gray-200 to-gray-600">Public</span>.
            </h1>
            <p class="text-gray-400 max-w-xl mx-auto text-lg">
                è¿™é‡Œæ˜¯æˆ‘ç§¯ç´¯å·¥ä½œç»éªŒã€å­˜å‚¨æ–‡æ¡£å’Œç¢ç¢å¿µçš„æ•°å­—èŠ±å›­ã€‚<br>
                <span v-if="!user">éƒ¨åˆ†å†…å®¹ä»…ä¸»äººå¯è§ã€‚</span>
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div v-for="note in notes" :key="note.id" 
                 class="group relative bg-surface border border-white/5 rounded-2xl p-6 hover:border-white/20 transition duration-300 flex flex-col h-64">
                
                <div class="flex justify-between items-start mb-4">
                    <span :class="note.type === 'file' ? 'bg-blue-500/10 text-blue-400' : 'bg-purple-500/10 text-purple-400'" 
                          class="px-2 py-1 rounded text-xs font-mono uppercase">
                        {{ note.type }}
                    </span>
                    <span v-if="!note.is_public" class="text-gray-600" title="ç§å¯†å†…å®¹">ğŸ”’</span>
                </div>

                <h3 class="text-xl font-bold text-gray-100 mb-2 group-hover:text-white transition">{{ note.title }}</h3>
                
                <div class="flex-1 overflow-hidden text-sm text-gray-500 md-content relative">
                    <div v-html="renderMarkdown(note.content)"></div>
                    <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-surface to-transparent"></div>
                </div>

                <div v-if="user" class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                    <button @click="editNote(note)" class="p-2 bg-white text-black rounded-full hover:scale-110 transition shadow-lg">âœ</button>
                </div>
            </div>
        </div>
    </main>


    <div v-if="showLogin && !user" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm transition-all">
        <div class="glass p-8 rounded-2xl w-full max-w-md relative animate-fade-in-up">
            <button @click="showLogin = false" class="absolute top-4 right-4 text-gray-500 hover:text-white">âœ•</button>
            <h2 class="text-2xl font-bold text-white mb-6 text-center">èº«ä»½éªŒè¯</h2>
            <div class="space-y-4">
                <input v-model="email" type="email" placeholder="Email" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-white/50 outline-none transition">
                <input v-model="password" type="password" placeholder="Password" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-white/50 outline-none transition">
                <button @click="handleLogin" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition">Unlock</button>
            </div>
        </div>
    </div>


    <div v-if="showEditor && user" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="bg-surface w-full max-w-4xl h-[80vh] rounded-2xl border border-white/10 flex flex-col shadow-2xl overflow-hidden">
            
            <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-void">
                <h3 class="text-white font-bold">{{ isEditing ? 'ç¼–è¾‘å†…å®¹' : 'æ–°å»ºå†…å®¹' }}</h3>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" v-model="form.is_public" class="w-4 h-4">
                        <span :class="form.is_public ? 'text-green-400' : 'text-gray-500'">{{ form.is_public ? 'å…¬å¼€ Public' : 'ç§å¯† Private' }}</span>
                    </label>
                    <button @click="closeEditor" class="text-gray-400 hover:text-white">å–æ¶ˆ</button>
                    <button @click="saveNote" class="bg-white text-black px-6 py-1.5 rounded-full font-bold hover:bg-gray-200 transition">
                        {{ isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
                    </button>
                </div>
            </div>

            <div class="flex-1 flex flex-col md:flex-row">
                <div class="flex-1 p-6 flex flex-col gap-4 border-r border-white/5">
                    <input v-model="form.title" placeholder="è¾“å…¥æ ‡é¢˜..." class="bg-transparent text-2xl font-bold text-white outline-none placeholder-gray-600">
                    
                    <div class="flex gap-4 text-sm">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" value="note" v-model="form.type">
                            <span class="text-gray-300">çº¯ç¬”è®° (Markdown)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" value="file" v-model="form.type">
                            <span class="text-gray-300">æ–‡ä»¶é“¾æ¥</span>
                        </label>
                    </div>

                    <textarea v-if="form.type === 'note'" v-model="form.content" placeholder="åœ¨è¿™é‡Œå†™ Markdown..." class="flex-1 bg-void/50 p-4 rounded-lg text-gray-300 font-mono outline-none resize-none border border-white/5 focus:border-white/20"></textarea>
                    
                    <div v-else class="flex-1 bg-void/50 p-4 rounded-lg border border-dashed border-gray-700 flex flex-col items-center justify-center text-gray-500">
                        <p>è¯·æ‰‹åŠ¨ç²˜è´´æ–‡ä»¶é“¾æ¥ (File URL)</p>
                        <input v-model="form.content" placeholder="https://..." class="w-full mt-4 bg-black border border-gray-700 p-2 rounded text-white">
                        <p class="text-xs mt-2 text-gray-600">ç›®å‰æš‚æœªå¼€å¯è‡ªåŠ¨ä¸Šä¼ ï¼Œè¯·å» Supabase Storage ä¸Šä¼ åå¤åˆ¶é“¾æ¥å¡«å…¥ã€‚</p>
                    </div>
                </div>

                <div class="flex-1 p-6 bg-black/20 overflow-y-auto">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-4 tracking-widest">Preview</h4>
                    <div class="md-content text-gray-300" v-html="renderMarkdown(form.content)"></div>
                </div>
            </div>
            
            <div v-if="isEditing" class="p-4 bg-red-900/10 border-t border-red-900/20 flex justify-between items-center">
                <span class="text-xs text-red-400">å±é™©åŒºåŸŸ</span>
                <button @click="deleteNote" class="text-xs text-red-500 hover:text-red-300 underline">åˆ é™¤æ­¤æ¡ç›®</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, reactive } = Vue
    const { createClient } = supabase

    // ==========================================
    // ğŸ”´ å¿…å¡«ï¼šä½ çš„ Supabase é…ç½®
    // ==========================================
    const SUPABASE_URL = 'https://fjuxtlzbeeexyczfrqsq.supabase.co'
    const SUPABASE_ANON_KEY = 'sb_publishable_1Q5sjgjl5Fmd4-nDlhrFWA_wWYgAUDu'

    const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    createApp({
        setup() {
            // --- çŠ¶æ€å˜é‡ ---
            const user = ref(null)
            const showLogin = ref(false)
            const showEditor = ref(false)
            const email = ref('')
            const password = ref('')
            const notes = ref([])
            const isSaving = ref(false)
            
            // è¡¨å•æ•°æ® (ç”¨äºæ–°å»º/ç¼–è¾‘)
            const form = reactive({
                id: null,
                title: '',
                content: '',
                is_public: false, // é»˜è®¤ç§å¯†
                type: 'note'
            })

            // --- ç”Ÿå‘½å‘¨æœŸ ---
            onMounted(async () => {
                // 1. æ£€æŸ¥æœ‰æ²¡æœ‰ç™»å½•
                const { data: { session } } = await _supabase.auth.getSession()
                user.value = session?.user || null
                
                // 2. åŠ è½½æ•°æ®
                fetchNotes()

                // 3. ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
                _supabase.auth.onAuthStateChange((_event, session) => {
                    user.value = session?.user || null
                    fetchNotes() // çŠ¶æ€å˜äº†(ç™»å½•/ç™»å‡º)éƒ½è¦é‡æ–°æ‹‰æ•°æ®
                })
            })

            // --- æ ¸å¿ƒé€»è¾‘ ---

            // æ‹‰å–ç¬”è®°ï¼šæ ¹æ®æ˜¯å¦ç™»å½•ï¼ŒSupabase RLS ä¼šè‡ªåŠ¨å†³å®šè¿”å›ä»€ä¹ˆæ•°æ®
            // æ²¡ç™»å½• -> åªèƒ½æŸ¥åˆ° is_public=true
            // ç™»å½•äº† -> èƒ½æŸ¥åˆ°æ‰€æœ‰
            const fetchNotes = async () => {
                const { data, error } = await _supabase
                    .from('notes')
                    .select('*')
                    .order('created_at', { ascending: false })
                
                if (error) console.error('è·å–å¤±è´¥:', error)
                else notes.value = data
            }

            // ç™»å½•
            const handleLogin = async () => {
                const { error } = await _supabase.auth.signInWithPassword({ email: email.value, password: password.value })
                if (error) alert('ç™»å½•å¤±è´¥: ' + error.message)
                else showLogin.value = false // ç™»å½•æˆåŠŸå…³é—­å¼¹çª—
            }

            // ç™»å‡º
            const handleLogout = async () => {
                await _supabase.auth.signOut()
                // ç™»å‡ºåéœ€è¦æ¸…ç©ºæ•æ„Ÿæ•°æ®ï¼Œé‡æ–°æ‹‰å–å…¬å¼€æ•°æ®
                fetchNotes()
            }

            // æ‰“å¼€ç¼–è¾‘å™¨ (æ–°å»ºæ¨¡å¼)
            const openNewEditor = () => {
                form.id = null
                form.title = ''
                form.content = ''
                form.is_public = false
                form.type = 'note'
                showEditor.value = true
            }

            // æ‰“å¼€ç¼–è¾‘å™¨ (ç¼–è¾‘æ¨¡å¼)
            const editNote = (note) => {
                form.id = note.id
                form.title = note.title
                form.content = note.content
                form.is_public = note.is_public
                form.type = note.type
                showEditor.value = true
            }

            // ä¿å­˜é€»è¾‘ (åŒºåˆ†æ–°å»ºå’Œæ›´æ–°)
            const saveNote = async () => {
                if (!form.title) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º')
                isSaving.value = true
                
                const noteData = {
                    user_id: user.value.id,
                    title: form.title,
                    content: form.content,
                    is_public: form.is_public,
                    type: form.type
                }

                if (form.id) {
                    // æ›´æ–°æ¨¡å¼
                    await _supabase.from('notes').update(noteData).eq('id', form.id)
                } else {
                    // æ–°å»ºæ¨¡å¼
                    await _supabase.from('notes').insert(noteData)
                }

                isSaving.value = false
                showEditor.value = false // å…³é—­å¼¹çª—
                fetchNotes() // åˆ·æ–°åˆ—è¡¨
            }

            // åˆ é™¤é€»è¾‘
            const deleteNote = async () => {
                if(!confirm('ç¡®å®šæ°¸ä¹…åˆ é™¤å—ï¼Ÿ')) return
                await _supabase.from('notes').delete().eq('id', form.id)
                showEditor.value = false
                fetchNotes()
            }

            // å·¥å…·ï¼šMarkdown æ¸²æŸ“
            const renderMarkdown = (text) => {
                return text ? marked.parse(text) : ''
            }
            
            // å…³é—­ç¼–è¾‘å™¨
            const closeEditor = () => {
                showEditor.value = false
            }

            return {
                user, showLogin, showEditor, email, password, notes, form, isSaving,
                handleLogin, handleLogout, editNote, saveNote, deleteNote, renderMarkdown, closeEditor,
                // è®¡ç®—å±æ€§ï¼šåˆ¤æ–­å½“å‰æ˜¯ç¼–è¾‘è¿˜æ˜¯æ–°å»º
                isEditing: Vue.computed(() => !!form.id)
            }
        }
    }).mount('#app')
</script>
</body>
</html>
